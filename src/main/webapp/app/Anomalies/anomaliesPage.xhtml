<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<ui:composition template="/WEB-INF/templates.xhtml"
                xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="jakarta.faces.html"
                xmlns:f="jakarta.faces.core"
                xmlns:p="http://primefaces.org/ui"
                xmlns:ui="jakarta.faces.facelets">

        <ui:define name="metadata">
            <f:metadata>
                <f:viewAction action="#{anomalyBean.breadcrumb()}" />
            </f:metadata>
        </ui:define>

    <ui:define name="title">Anomaly Management</ui:define>
    <ui:define name="content">
        <div class="main-content">
            <h:outputStylesheet library="css" name="anomalyCss.css"/>

            <h:form id="anomalyForm">
                <div class="anomalies-container">
                    <!-- Page Header -->
                    <div class="page-header">
                        <h2><i class="fa-solid fa-building-shield" style="color: black;"></i> Anomaly Management</h2>
<!--                        <h1 class="page-title" style="margin: 0;">Anomalies Management</h1>-->
                        <p class="page-subtitle">Monitor and manage access anomalies </p>
                    </div>


                    <!-- Severity Cards -->
                    <div class="cards-grid">
                        <div class="severity-card severe #{anomalyBean.selectedSeverity == 'SEVERE' ? 'active' : ''}">
                            <p:commandLink action="#{anomalyBean.filterBySeverity('SEVERE')}" 
                                           update="@form" 
                                           styleClass="card-link">
                                <div class="card-header">
                                    <div class="card-title">Severe</div>
                                    <div class="card-icon">
                                        <i class="fas fa-exclamation-triangle"></i>
                                    </div>
                                </div>
                                <div class="card-count">#{anomalyBean.severeCount}</div>
                                <div class="card-description">Critical security violations requiring immediate attention</div>
                            </p:commandLink>
                        </div>

                        <div class="severity-card warning #{anomalyBean.selectedSeverity == 'WARNING' ? 'active' : ''}">
                            <p:commandLink action="#{anomalyBean.filterBySeverity('WARNING')}" 
                                           update="@form" 
                                           styleClass="card-link">
                                <div class="card-header">
                                    <div class="card-title">Warning</div>
                                    <div class="card-icon">
                                        <i class="fas fa-exclamation-circle"></i>
                                    </div>
                                </div>
                                <div class="card-count">#{anomalyBean.warningCount}</div>
                                <div class="card-description">Potential security issues that need review</div>
                            </p:commandLink>
                        </div>

                        <div class="severity-card info #{anomalyBean.selectedSeverity == 'INFO' ? 'active' : ''}">
                            <p:commandLink action="#{anomalyBean.filterBySeverity('INFO')}" 
                                           update="@form" 
                                           styleClass="card-link">
                                <div class="card-header">
                                    <div class="card-title">Info</div>
                                    <div class="card-icon">
                                        <i class="fas fa-info-circle"></i>
                                    </div>
                                </div>
                                <div class="card-count">#{anomalyBean.infoCount}</div>
                                <div class="card-description">Informational anomalies for tracking purposes</div>
                            </p:commandLink>
                        </div>
                    </div>

                    <!-- Controls Section -->
                    <div class="controls-section">
                        <div class="controls-header">
                            <h2 style="margin: 0; color: var(--text-primary); font-size: 1.5rem;">Anomaly Details</h2>

                            <!-- Status Toggle -->
                            <div class="status-toggle">
                                <p:commandButton value="Unattended" 
                                                 styleClass="toggle-btn #{anomalyBean.selectedStatus == 'UNATTENDED' ? 'active UNATTENDED' : ''}"
                                                 action="#{anomalyBean.filterByStatus('UNATTENDED')}" 
                                                 update="@form" />
                                <p:commandButton value="Pending" 
                                                 styleClass="toggle-btn #{anomalyBean.selectedStatus == 'PENDING' ? 'active PENDING' : ''}"
                                                 action="#{anomalyBean.filterByStatus('PENDING')}" 
                                                 update="@form" />
                                <p:commandButton value="Resolved" 
                                                 styleClass="toggle-btn #{anomalyBean.selectedStatus == 'RESOLVED' ? 'active RESOLVED' : ''}"
                                                 action="#{anomalyBean.filterByStatus('RESOLVED')}" 
                                                 update="@form" />
                            </div>
                        </div>

                        <!-- Filters -->
                        <div class="filters-row">
                            <div class="filter-group">
                                <label class="filter-label">Search Employee</label>
                                <p:inputText value="#{anomalyBean.employeeFilter}" 
                                             styleClass="modern-input"
                                             placeholder="Enter employee name..."
                                             onkeyup="if (event.keyCode === 13)
                                                         PF('filterBtn').click();" />
                            </div>

                            <div class="filter-group">
                                <label class="filter-label">Device</label>
                                <p:selectOneMenu value="#{anomalyBean.deviceFilter}" 
                                                 styleClass="modern-input">
                                    <f:selectItem  itemLabel="All Devices" itemValue="#{null}" />
                                    <f:selectItems value="#{anomalyBean.availableDevices}" 
                                                   var="device" 
                                                   itemValue="#{device.id}" 
                                                   itemLabel="#{device.deviceName}" />
                                </p:selectOneMenu>
                            </div>

                            <div class="filter-group">
                                <label class="filter-label">Entrance</label>
                                <p:selectOneMenu value="#{anomalyBean.entranceFilter}" 
                                                 styleClass="modern-input">
                                    <f:selectItem itemLabel="All Entrances" itemValue= "#{null}" />
                                    <f:selectItems value="#{anomalyBean.availableEntrances}" 
                                                   var="entrance" 
                                                   itemValue="#{entrance.id}" 
                                                   itemLabel="#{entrance.entranceName}" />
                                </p:selectOneMenu>
                            </div>

                            <div class="filter-group">
                                <label class="filter-label">Date</label>
                                <p:calendar value="#{anomalyBean.dateFilter}"                                            
                                            style="width: 100%;"
                                            pattern="dd-MM-yyyy" 
                                            placeholder="Select date..." />
                            </div>
                        </div>

                        <div style="display: flex; gap: 1rem; justify-content: space-between;">
                            <p:commandButton value="Clear All" 
                                             styleClass="ui-button-raised ui-button-danger"
                                             icon="fa-solid fa-spinner" iconPos="left" 
                                             action="#{anomalyBean.clearFilters}" 
                                             update="@form" />
                            <p:commandButton id="filterBtn" 
                                             value="Apply Filters" 
                                             styleClass="ui-button-raised ui-button-success"
                                             icon="pi pi-search" iconPos="left" 
                                             action="#{anomalyBean.applyFilters}" 
                                             update="@form" />
                        </div>
                    </div>

                    <!-- Anomalies Table -->
                    <div class="anomalies-table">
                        <div class="table-header">
                            <div class="table-title">
                                #{anomalyBean.selectedSeverity != null ? anomalyBean.selectedSeverity : 'All'} Anomalies
                                <span style="color: var(--text-secondary); font-weight: normal;">(#{anomalyBean.filteredAnomalies.size()})</span>
                            </div>
                            <div class="table-subtitle">
                                Status: #{anomalyBean.selectedStatus != null ? anomalyBean.selectedStatus : 'All'} | 
                                Last updated: #{anomalyBean.lastUpdated}
                            </div>
                        </div>

                        <h:panelGroup id="anomaliesTable" >
                            <ui:fragment rendered="#{anomalyBean.loading}">
                                <div class="loading-state">
                                    <div class="spinner"></div>
                                    <p>Loading anomalies...</p>
                                </div>
                            </ui:fragment>

                            <ui:fragment rendered="#{!anomalyBean.loading and empty anomalyBean.filteredAnomalies}">
                                <div class="empty-state">
                                    <div class="empty-icon">
                                        <i class="fas fa-search"></i>
                                    </div>
                                    <h3>No anomalies found</h3>
                                    <p>Try adjusting your filters or check back later.</p>
                                </div>
                            </ui:fragment>

                            <ui:repeat value="#{anomalyBean.filteredAnomalies}" var="anomaly" 
                                       rendered="#{!anomalyBean.loading and not empty anomalyBean.filteredAnomalies}">
                                <div class="anomaly-row">
                                    <div class="anomaly-header">
                                        <div class="anomaly-info">
                                            <div class="anomaly-title">#{anomalyBean.formatAnomalyType(anomaly.anomalyType)}</div>
                                            <div class="anomaly-meta">
                                                <div class="meta-item">
                                                    <i class="fas fa-user"></i>
                                                    <strong>#{anomaly.employee.fullName}</strong>
                                                </div>
                                                <div class="meta-item">
                                                    <i class="fas fa-door-open"></i>
                                                    #{anomaly.entrance.entranceName}
                                                </div>
                                                <div class="meta-item">
                                                    <i class="fas fa-mobile-alt"></i>
                                                    #{anomaly.device.deviceName}
                                                </div>
                                                <div class="meta-item">
                                                    <i class="fas fa-clock"></i>
                                                    <h:outputText value="#{anomalyBean.formatTimestamp(anomaly)}">
                                                    </h:outputText>
                                                </div>
                                            </div>
                                        </div>
                                        <div style="display: flex; gap: 0.5rem; align-items: flex-start;">
                                            <span class="severity-badge #{anomaly.anomalySeverity}">
                                                #{anomaly.anomalySeverity}
                                            </span>
                                            <span class="status-badge #{anomaly.anomalyStatus}">
                                                #{anomaly.anomalyStatus}
                                            </span>
                                        </div>
                                    </div>

                                    <p style="margin: 0 0 1rem 0; color: var(--text-secondary); font-size: 0.95rem;">
                                        #{anomaly.message}
                                    </p>

                                    <div class="anomaly-actions">
                                        <p:commandButton value="Mark as Pending" 
                                                         styleClass="action-btn primary ui-button-raised ui-button-warning"
                                                         action="#{anomalyBean.markAsPending(anomaly)}" 
                                                         update="@form"
                                                         rendered="#{anomaly.anomalyStatus == 'UNATTENDED'}" />

                                        <p:commandButton value="Resolve" 
                                                         styleClass="action-btn success"
                                                         action="#{anomalyBean.resolveAnomaly(anomaly)}" 
                                                         update="@form"
                                                         rendered="#{anomaly.anomalyStatus != 'RESOLVED'}" />

                                        <p:commandButton value="Assign Handler" 
                                                         styleClass="action-btn secondary"
                                                         action="#{anomalyBean.showAssignDialog(anomaly)}" 
                                                         update=":assignDialog"
                                                         oncomplete="PF('assignDialog').show()"
                                                         rendered="#{anomaly.handledBy == null}" />

                                        <p:commandButton value="View Details" 
                                                         styleClass="action-btn secondary"
                                                         action="#{anomalyBean.showDetails(anomaly)}" 
                                                         update=":detailsDialog"
                                                         oncomplete="PF('detailsDialog').show()" />
                                    </div>
                                </div>
                            </ui:repeat>
                        </h:panelGroup>
                    </div>
                </div>
            </h:form>

            <!-- Assign Handler Dialog -->
            <p:dialog id="assignDialog" header="Assign Handler" widgetVar="assignDialog" modal="true" resizable="true"
                      width="300px"
                      >
                <h:form>
                    <p:selectOneMenu value="#{anomalyBean.selectedHandler}" style="width: 100%; margin-bottom: 1rem; overflow: hidden">
                        <f:selectItem itemValue="" itemLabel="Select a handler..." />
                        <f:selectItems value="#{anomalyBean.availableHandlers}" 
                                       var="handler" 
                                       itemValue="#{handler.id}" 
                                       itemLabel="#{handler.username}"/>
                    </p:selectOneMenu>
                    <div style="text-align: right; margin-top: 1rem; display:flex; justify-content:space-between ; gap:10px;">                     
                        <p:commandButton value="Assign" 
                                         styleClass="ui-confirmdialog-yes rounded-button"
                                         action="#{anomalyBean.assignHandler}" 
                                         update=":anomalyForm:anomaliesTable"
                                         oncomplete ="PF('assignDialog').hide();" />
                        
                        <p:commandButton value="Cancel" 
                                         styleClass="ui-confirmdialog-no rounded-button ui-button-secondary"
                                         oncomplete ="PF('assignDialog').hide();" />
                    </div>
                </h:form>
            </p:dialog>

            <!-- Details Dialog -->
            <p:dialog id="detailsDialog" header="Anomaly Details" widgetVar="detailsDialog" modal="true" resizable="false" width="600">
                <h:form>
                    <p:panelGrid columns="2" style="width: 100%;">
                        <p:outputLabel value="Type:" style="font-weight: bold;" />
                        
                        <h:outputText rendered="#{not empty anomalyBean.selectedAnomaly and not empty anomalyBean.selectedAnomaly.anomalyType}"
                                      value="#{anomalyBean.getFormattedAnomalyType(anomalyBean.selectedAnomaly.anomalyType)}"/>
                        <h:outputText rendered="#{empty anomalyBean.selectedAnomaly or empty anomalyBean.selectedAnomaly.anomalyType}"
                                      value="Not selected yet"/>

                        <p:outputLabel value="Employee:" style="font-weight: bold;" />
                        <h:outputText value="#{anomalyBean.selectedAnomaly.employee.fullName}" />

                        <p:outputLabel value="Severity:" style="font-weight: bold;" />
                        <h:outputText value="#{anomalyBean.selectedAnomaly.anomalySeverity}" />

                        <p:outputLabel value="Status:" style="font-weight: bold;" />
                        <h:outputText value="#{anomalyBean.selectedAnomaly.anomalyStatus}" />

                        <p:outputLabel value="Timestamp:" style="font-weight: bold;" />
                        <h:outputText value="#{anomalyBean.formatTimestamp(anomalyBean.selectedAnomaly)}">
                        </h:outputText>

                        <p:outputLabel value="Device:" style="font-weight: bold;" />
                        <h:outputText value="#{anomalyBean.selectedAnomaly.device.deviceName}" />

                        <p:outputLabel value="Entrance:" style="font-weight: bold;" />
                        <h:outputText value="#{anomalyBean.selectedAnomaly.entrance.entranceName}" />

                        <p:outputLabel value="Handler:" style="font-weight: bold;" />
                        <h:outputText value="#{anomalyBean.selectedAnomaly.handledBy != null ? anomalyBean.selectedAnomaly.handledBy.username : 'Unassigned'}" />

                        <p:outputLabel value="Message:" style="font-weight: bold;" />
                        <h:outputText value="#{anomalyBean.selectedAnomaly.message}" />
                    </p:panelGrid>
                </h:form>
            </p:dialog>
        </div>

    </ui:define>
</ui:composition>