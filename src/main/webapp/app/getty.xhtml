<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" 
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:p="http://primefaces.org/ui"
      xmlns:ui="http://java.sun.com/jsf/facelets">
    <ui:composition template="/WEB-INF/templates.xhtml">
        <ui:define name="breadcrumb">
            <nav>
                <ul class="breadcrumb">
                    <li><h:link value="Home" outcome="/app/DashboardMgt.xhtml" /></li>
                    <li class="active">Overview</li>
                </ul>
            </nav>
        </ui:define>
        <ui:define name="content">  
            <h:body>
                <h:form>
                    <p:growl id="messages" showDetail="true" />

                    <!-- Loading Overlay -->
                    <p:outputPanel id="loadingPanel" styleClass="loading-overlay" rendered="#{!empty viewScope.loading}">
                        <p:spinner style="font-size: 40px; color: #4c84ff;" />
                    </p:outputPanel>

                    <p:panel style="margin-top: 20px;">
                        <p:commandButton value="Export Recent Loans (CSV)" 
                                         icon="pi pi-download" 
                                         actionListener="#{dashboardBeanG.exportRecentLoansToCSV}" 
                                         ajax="false" 
                                         styleClass="ui-button-success"/>

                        <p:spacer width="10"/>

                        <p:commandButton value="Generate Loan Summary Report (PDF)" 
                                         icon="pi pi-file-pdf" 
                                         actionListener="#{dashboardBeanG.generateLoanSummaryReport}" 
                                         ajax="false" 
                                         styleClass="ui-button-secondary"/>
                    </p:panel>
                    <div class="card">
                        <div class="dashboard">
                            <h1 class="dashboard-title dashstyle">Financial Dashboard</h1>

                            <div class="cards-container">
                                <!-- Card 1 - Total Loans -->
                                <p:commandLink action="#{dashboardBeanG.goToLoansList}" 
                                               styleClass="card card-primary-blue check" ajax="false">
                                    <div class="card-content">
                                        <div class="card-title">Total Loans</div>
                                        <div class="card-value">
                                            <h:outputText value="#{dashboardBeanG.totalLoans}" />
                                        </div>
                                    </div>
                                    <div class="card-icon">
                                        <i class="fas fa-money-bill-wave"></i>
                                    </div>
                                </p:commandLink>

                                <!-- Card 2 - Active Customers -->
                                <p:commandLink action="#{dashboardBeanG.goToCustomerListPage}" 
                                               styleClass="card card-sky-blue check" ajax="false">
                                    <div class="card-content">
                                        <div class="card-title">Active Customers</div>
                                        <div class="card-value">
                                            <h:outputText value="#{dashboardBeanG.allCustomers}" />
                                        </div>
                                    </div>
                                    <div class="card-icon">
                                        <i class="fas fa-users"></i>
                                    </div>
                                </p:commandLink>

                                <!-- Card 3 - Pending Approvals -->
                                <p:commandLink action="#{dashboardBeanG.goToPendingApprovals()}" 
                                               styleClass="card card-navy-blue check">
                                    <div class="card-content">
                                        <div class="card-title">Pending Approvals</div>
                                        <div class="card-value">
                                            <h:outputText value="#{dashboardBeanG.pendingLoan}" />
                                        </div>
                                    </div>
                                    <div class="card-icon">
                                        <i class="fas fa-clock"></i>
                                    </div>
                                </p:commandLink>

                                <!-- Card 4 - OverDue Loans -->
                                <p:commandLink action="#{dashboardBeanG.goToOverdueLoans()}" styleClass="card card-steel-blue check" ajax="false">
                                    <div class="card-content">
                                        <div class="card-title">OverDue Loans</div>
                                        <div class="card-value">                                    
                                            <h:outputText value="#{dashboardBeanG.overdueLoans}" />
                                        </div>
                                    </div>
                                    <div class="card-icon">
                                        <i class="fas fa-exclamation-triangle"></i>
                                    </div>
                                </p:commandLink>

                                <!-- Card 5 - Active Loans -->
                                <p:commandLink action="#{dashboardBeanG.goToActiveLoans()}" styleClass="card card-indigo-blue check" ajax="false">
                                    <div class="card-content">
                                        <div class="card-title">Active Loans</div>
                                        <div class="card-value">
                                            <h:outputText value="#{dashboardBeanG.activeLoans}" />
                                        </div>
                                    </div>
                                    <div class="card-icon">
                                        <i class="fas fa-check-circle"></i>
                                    </div>
                                </p:commandLink>

                                <!-- Card 6 - Total Users (NEW CARD) -->
                                <p:commandLink action="#{dashboardBeanG.goToUsersManagement}" 
                                               styleClass="card card-indigo-blue check" ajax="false">
                                    <div class="card-content">
                                        <div class="card-title">Total Users</div>
                                        <div class="card-value">
                                            <h:outputText value="#{dashboardBeanG.totalUsers}" />
                                        </div>
                                    </div>
                                    <div class="card-icon">
                                        <i class="fas fa-user-shield"></i>
                                    </div>
                                </p:commandLink>

                                <!-- Card 6 - Total Repaid -->
                                <p:commandLink action="#{dashboardBeanG.goToRepaymentHistory}" 
                                               styleClass="card card-cyan-blue check" ajax="false">
                                    <div class="card-content">
                                        <div class="card-title">Total Repaid</div>
                                        <div class="card-value">
                                            <h:outputText value="#{dashboardBeanG.totalRepaid}">
                                                <f:convertNumber type="currency" currencySymbol="GHS " groupingUsed="true" maxFractionDigits="2" />
                                            </h:outputText>
                                        </div>
                                    </div>
                                    <div class="card-icon">
                                        <i class="fas fa-dollar-sign"></i>
                                    </div>
                                </p:commandLink>

                                <!-- Card 8 - Disbursed Today (FIXED - Added click handler) -->
                                <p:commandLink action="#{dashboardBeanG.goToDisbursedToday}" 
                                               styleClass="card card-light-blue check" ajax="false">
                                    <div class="card-content">
                                        <div class="card-title">Disbursed Today</div>
                                        <div class="card-value">
                                            <h:outputText value="#{dashboardBeanG.disbursedToday}">
                                                <f:convertNumber type="currency" currencySymbol="GHS " groupingUsed="true" maxFractionDigits="2" />
                                            </h:outputText>
                                        </div>
                                    </div>
                                    <div class="card-icon">
                                        <i class="fa fa-money-bill-wave"></i>
                                    </div>
                                </p:commandLink>

                                <!-- Card 8 - Collected This Month -->
                                <div class="card card-royal-blue check">
                                    <div class="card-content">
                                        <div class="card-title">Collected This Month</div>
                                        <div class="card-value">
                                            <h:outputText value="#{dashboardBeanG.collectedThisMonth}">
                                                <f:convertNumber type="currency" currencySymbol="GHS " groupingUsed="true" maxFractionDigits="2" />
                                            </h:outputText>
                                        </div>
                                    </div>
                                    <div class="card-icon">
                                        <i class="fa fa-hand-holding-usd"></i>
                                    </div>
                                </div>
                            </div>
                            <!-- Button to simulate loading (for demo purposes) -->
                        </div>
                    </div>

                    <p:panelGrid columns="2" layout="grid" styleClass="ui-panelgrid-blank" columnClasses="ui-grid-col-6,ui-grid-col-6" style="margin-top:10px; ">                     
                        <p:panel>
                            <h2>Loan Type Distribution</h2>
                            <p:pieChart model="#{dashboardBeanG.loanTypeChart}"/>
                        </p:panel>


                        <p:panel>
                            <f:facet name="header">Loans by Status</f:facet>
                            <p:barChart model="#{dashboardBeanG.loanStatusBarChart}"/>
                        </p:panel>


                        <p:panel>
                            <h2>Loans by Installment Type</h2>
                            <p:barChart model="#{dashboardBeanG.loansByInstallmentTypeChart}" />
                        </p:panel>

                        <!-- Chart 4 - NEW: Monthly Disbursement Trend -->
                        <p:panel>
                            <h2>Monthly Disbursement Trend</h2>
                            <p:barChart model="#{dashboardBeanG.monthlyDisbursementChart}" />
                        </p:panel>

                        <!-- Chart 5 - NEW: Loan Performance Metrics -->
                        <p:panel>
                            <h2>Loan Performance</h2>
                            <p:barChart model="#{dashboardBeanG.loanPerformanceChart}" />
                        </p:panel>

                        <!-- Chart 6 - NEW: Quick Stats Table -->
                        <p:panel>
                            <h2>Quick Statistics</h2>
                            <p:dataTable value="#{dashboardBeanG.quickStats}" var="stat" styleClass="quick-stats-table">
                                <p:column headerText="Metric">
                                    <h:outputText value="#{stat.metric}" />
                                </p:column>
                                <p:column headerText="Count" styleClass="text-center">
                                    <h:outputText value="#{stat.count}" styleClass="stat-number"/>
                                </p:column>
                                <p:column headerText="Percentage" styleClass="text-center">
                                    <h:outputText value="#{stat.percentage}%" styleClass="stat-percentage"/>
                                </p:column>
                            </p:dataTable>
                        </p:panel>


                    </p:panelGrid>







                    <!-- Recent Loan Applications Table -->
                    <p:panel>
                        <h2>Recent Loan Applications</h2>
                        <p:dataTable value="#{dashboardBeanG.recentLoans}" var="loan" rows="5" paginator="true" paginatorPosition="bottom" style="margin-top: 10px;">
                            <p:column headerText="Customer">
                                <h:outputText value="#{loan.customer.surname} #{loan.customer.forenames}" />
                            </p:column>
                            <p:column headerText="Amount">
                                <h:outputText value="#{loan.amount}">
                                    <f:convertNumber type="currency" currencySymbol="GHS " groupingUsed="true" maxFractionDigits="2" />
                                </h:outputText>
                            </p:column>

                            <p:column headerText="Loan Status">
                                <h:outputText value="#{loan.status.displayName}" 
                                              styleClass="status-badge #{loan.status.displayName.toLowerCase()}" />
                            </p:column>
                        </p:dataTable>
                    </p:panel>

                    <p:dialog widgetVar="statusDialog" modal="true" draggable="false" closable="false" resizable="false" style="width: 200px; height: 100px;">
                        <p:outputPanel>
                            <h:outputText value="Loading..." />
                            <p:spinner style="font-size: 40px; color: #4c84ff;" />
                        </p:outputPanel>
                    </p:dialog>
                </h:form>
            </h:body>
            <h:outputStylesheet name="css/summary.css"/>    
        </ui:define>
        <style>

            .dashboard {
                max-width: 1200px;
                margin: 0 auto;
            }

            .check{
                border-radius: 10px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
                padding: 20px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                transition: transform 0.3s ease, box-shadow 0.3s ease;
                height: 120px;
            }

            .dashboard-title {
                font-size: 24px;
                font-weight: bold;
                color: #333;
                margin-bottom: 20px;
                text-align: center;
            }

            .cards-container {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                gap: 20px;
            }

            .card {
                border-radius: 10px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
                padding: 20px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                transition: transform 0.3s ease, box-shadow 0.3s ease;
                height: 120px;
            }

            .card:hover {
                transform: translateY(-5px);
                box-shadow: 0 8px 16px rgba(0, 0, 0, 0.12);
            }

            .check:hover {
                transform: translateY(-5px);
                box-shadow: 0 8px 16px rgba(0, 0, 0, 0.12);
            }

            .card-content {
                display: flex;
                flex-direction: column;
            }

            .card-title {
                font-size: 14px;
                color: #666;
                margin-bottom: 8px;
                font-weight: 500;
            }

            .card-value {
                font-size: 20px;
                font-weight: bold;
                color: #333;
            }

            .card-icon {
                font-size: 24px;
                display: flex;
                align-content: space-between;
                justify-content:flex-end;
                width: 50px;
                height: 50px;
                border-radius: 50%;
            }

            /* Card color variations */
            .check.blue .card-icon {
                color: #4c84ff;
                background-color: rgba(76, 132, 255, 0.1);
            }

            .card.green .card-icon {
                color: #2ed47a;
                background-color: rgba(46, 212, 122, 0.1);
            }

            .card.orange .card-icon {
                color: #ff8c00;
                background-color: rgba(255, 140, 0, 0.1);
            }

            .card.red .card-icon {
                color: #f95062;
                background-color: rgba(249, 80, 98, 0.1);
            }

            .card.purple .card-icon {
                color: #8e44ad;
                background-color: rgba(142, 68, 173, 0.1);
            }

            .card.teal .card-icon {
                color: #00a8a8;
                background-color: rgba(0, 168, 168, 0.1);
            }

            .card.pink .card-icon {
                color: #ff4f81;
                background-color: rgba(255, 79, 129, 0.1);
            }

            .card.yellow .card-icon {
                color: #ffa800;
                background-color: rgba(255, 168, 0, 0.1);
            }

            .loading-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
            }


            .card.card-purple {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
            }

            .card.card-purple .card-icon {
                color: rgba(255, 255, 255, 0.9);
                background-color: rgba(255, 255, 255, 0.1);
            }

            /* Quick stats table styling */
            .quick-stats-table {
                width: 100%;
                margin-top: 10px;
            }

            .quick-stats-table .stat-number {
                font-weight: bold;
                color: #2c3e50;
                font-size: 16px;
            }

            .quick-stats-table .stat-percentage {
                font-weight: bold;
                color: #27ae60;
            }

            /* Enhanced card hover effects */
            .card:hover .card-icon i {
                transform: scale(1.1);
                transition: transform 0.3s ease;
            }

            /* Responsive grid improvements */
            @media (max-width: 768px) {
                .cards-container {
                    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                    gap: 15px;
                }

                .card {
                    height: 100px;
                    padding: 15px;
                }

                .card-value {
                    font-size: 18px;
                }
            }

            /* Chart panel styling */
            .ui-panel .ui-panel-content {
                padding: 20px;
            }

            .ui-panel h2 {
                margin-top: 0;
                color: #2c3e50;
                font-size: 18px;
                margin-bottom: 15px;
            }
        </style>

    </ui:composition>


</html>