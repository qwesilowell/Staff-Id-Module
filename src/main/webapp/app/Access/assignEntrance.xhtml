<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<ui:composition template="/WEB-INF/template2.xhtml"
                xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="jakarta.faces.html"
                xmlns:f="jakarta.faces.core"
                xmlns:p="http://primefaces.org/ui"
                xmlns:ui="jakarta.faces.facelets">

    <ui:define name="metadata">
        <f:metadata>
            <f:viewAction action="#{assignEntranceBean.setupBreadcrumb}" />
        </f:metadata>
    </ui:define>
    <ui:define name="head">
        <h:outputStylesheet library="css" name="manageEmployee.css"/>
    </ui:define>
    <ui:define name="title">Assign Custom Entrances to Employees</ui:define>

    <!--    <ui:define name="metadata">
            <f:metadata>
                <f:viewAction action="#{loginBean.checkAccess('ADMIN')}" />
            </f:metadata>
        </ui:define>-->

    <ui:define name="content">
        <div class="main-content">
            <h:form id="assignEntranceForm">
                <p:growl id="messages" showSummary= "true" showDetail="true" life="6000" />

                <p:panel header="Assign Custom Entrances" style="background: white; border-radius: 8px;">
                    <!-- Search Bar -->
                    <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                        <p:inputText id="searchQuery" value="#{assignEntranceBean.searchQuery}"
                                     placeholder="Search by Name or Ghana Card" style="width: 300px; padding: 8px; border-radius: 4px; border: 1px solid #ccc;">
                            <p:ajax event="keyup" listener="#{assignEntranceBean.searchEmployees}" update="employeeTable" />
                        </p:inputText>
                    </div>

                    <!-- Employee Table -->
                    <p:dataTable id="employeeTable" value="#{assignEntranceBean.employees}" var="employee" paginator="true" paginatorPosition="bottom" rows="10">
                        <p:column headerText="Name">
                            <h:outputText value="#{employee.fullName}"/>
                        </p:column>
                        <p:column headerText="Role">
                            <h:outputText value="#{employee.role.roleName}"/>
                        </p:column>
                        <p:column headerText="National ID">
                            <h:outputText value="#{employee.ghanaCardNumber}"/>
                        </p:column>
                        <p:column headerText="Actions">
                            <p:commandLink value="#{employee.customEntrances.isEmpty() ? 'Assign Entrances' : 'Edit Entrances'}"
                                           action="#{assignEntranceBean.openAssignPopup(employee)}"
                                           update=":assignEntranceForm:assignEntranceDialog"
                                           oncomplete="PF('assignEntranceDialog').show()"
                                           style="#{employee.customEntrances.isEmpty() 
                                                    ? 'background: transparent; color: blue; border-radius: 4px; border:none;' 
                                                    : 'background: transparent; color: green; border-radius: 4px; border:none'}"/>
                        </p:column>
                        <p:column headerText="Assign Time Rule" style="text-align: center">    
                            <p:commandButton  class="rounded-button ui-button-info ui-button-outlined"  icon="fa-solid fa-business-time" action="#{assignEntranceBean.viewEmployee(employee)}"
                                              update=":sidebarForm" oncomplete="PF('sidebar2').show()" process="@this" />
                        </p:column>
                    </p:dataTable>
                </p:panel>
                <!-- Assign Entrance Dialog -->
                <p:dialog id="assignEntranceDialog" widgetVar="assignEntranceDialog" header="Assign Custom Entrances" modal="true" 
                          width="600px" blockScroll= "true" style="overflow-y: auto; max-height: 100%;" >
                    <div class="dialog-content" style="padding-bottom: 60px;">
                        <h:panelGrid columns="2" style="margin-bottom: 15px;">
                            <h:outputLabel value="Full Name:" style="font-weight: bold;" />
                            <h:outputText value="#{assignEntranceBean.selectedEmployee.fullName}"/>
                            <h:outputLabel value="National ID:"/>
                            <h:outputText value="#{assignEntranceBean.selectedEmployee.ghanaCardNumber}"/>
                        </h:panelGrid>

                        <!-- Available Entrances -->
                        <p:panel header="Available Entrances">
                            <p:selectManyMenu id="availableEntrances" value="#{assignEntranceBean.selectedEntrances}" showCheckbox="true">
                                <f:selectItems value="#{assignEntranceBean.filteredAvailableEntrances}" 
                                               var="entrance" 
                                               itemLabel="#{entrance.entranceName}" 
                                               itemValue="#{entrance}"/>
                            </p:selectManyMenu>
                        </p:panel>

                        <!-- Assigned Entrances --> 
                        <p:panel id="assignedEntrancesPanel" header="Assigned Entrances" style="margin-top: 15px; background-color: #f5f9ff; border: 1px solid #ccc; border-radius: 5px;"> 
                            <!-- Custom Entrances Section -->
                            <h:panelGroup rendered="#{not empty assignEntranceBean.assignedCustomEntrances}"> 
                                <p:outputLabel value="Custom Entrances:" style="font-weight: bold; font-size: 1.1em; color: #333;"/> 

                                <div class="scrollable-container" style="max-height: 400px; overflow-y: auto;   margin: 10px 0; padding: 5px; background-color: #fcfcfc;">

                                    <p:dataList value="#{assignEntranceBean.assignedCustomEntrances}"  
                                                var="entrance"  
                                                styleClass="custom-entrances-list"
                                                itemType="none"
                                                style="margin: 10px 0;"> 
                                        <div class="entrance-item" style="display: flex; align-items:flex-start; gap: 10px; border: 1px solid #ddd; padding: 12px 16px; border-radius: 8px; background-color: #f9f9f9; margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);"> 
                                            <h:outputText value="#{entrance.entranceName} (#{entrance.entranceId})" style="font-weight: 500;"/> 

                                            <p:commandButton icon="pi pi-trash" 
                                                             action="#{assignEntranceBean.removeCustomEntrance(entrance)}" 
                                                             update="@form" 
                                                             styleClass="rounded-button ui-button-danger ui-button-outlined" 
                                                             process="@this"
                                                             style="margin-left: auto;" > 
                                                <p:confirm header="Confirm Removal" 
                                                           message="Are you sure you want to remove access to '#{entrance.entranceName}' for #{assignEntranceBean.selectedEmployee.fullName}?"
                                                           icon="pi pi-exclamation-triangle"/>
                                            </p:commandButton>
                                        </div> 
                                    </p:dataList>
                                </div>

                            </h:panelGroup> 
                            <h:panelGroup rendered="#{empty assignEntranceBean.assignedCustomEntrances}"> 
                                <p:outputLabel value="No Custom Entrances Assigned" style="color: #666; font-style: italic;"/> 
                            </h:panelGroup> 

                            <div style="height: 20px;"></div> <!-- Spacer between sections -->

                            <!-- Role-Based Entrances Section -->
                            <h:panelGroup rendered="#{not empty assignEntranceBean.assignedRoleEntrances}"> 
                                <p:outputLabel value="Role-Based Entrances(Default Entrances):" style="font-weight: bold; font-size: 1.1em; color: #333; margin-top: 20px;"/> 
                                <div class="scrollable-container" style="max-height: 400px; overflow-y: auto;   margin: 10px 0; padding: 5px; background-color: #fcfcfc;">
                                    <p:dataList value="#{assignEntranceBean.assignedRoleEntrances}"  
                                                var="entrance"  
                                                styleClass="role-entrances-list"
                                                itemType="none"
                                                style="margin: 5px 0;"> 
                                        <div class="entrance-item" style="display: flex; align-items: center; border: 1px solid #e0e0e0; padding: 10px 14px; border-radius: 6px; background-color: #f5f5f5; margin-bottom: 10px;">
                                            <h:outputText value="#{entrance.entranceName} (#{entrance.entranceId})" style="padding: 5px;"/> 
                                        </div>
                                    </p:dataList> 
                                </div>
                            </h:panelGroup> 
                            <h:panelGroup rendered="#{empty assignEntranceBean.assignedRoleEntrances}"> 
                                <p:outputLabel value="No Role-Based Entrances Assigned" style="color: #666; font-style: italic;"/> 
                            </h:panelGroup> 
                        </p:panel>
                    </div>


                    <!-- Save/Cancel Buttons -->
                    <div class="dialog-footer" style="position: absolute; bottom: 0; left: 0; right: 0; background: #f8f8f8; padding: 12px; border-top: 1px solid #ddd; text-align: right; border-radius: 0 0 3px 3px;">
                        <p:commandButton value="Save" 
                                         action="#{assignEntranceBean.saveCustomEntrances}"
                                         update=":assignEntranceForm:employeeTable :assignEntranceForm:messages"
                                         oncomplete="PF('assignEntranceDialog').hide()"
                                         styleClass="action-buttons save-button"
                                         style="background: #007bff; color: white; border-radius: 4px; margin-right: 10px;"/>
                        <p:commandButton value="Cancel" 
                                         action="#{assignEntranceBean.cancel}"
                                         update=":assignEntranceForm"
                                         oncomplete="PF('assignEntranceDialog').hide()"
                                         styleClass="action-buttons cancel-button"
                                         style="background: #dc3545; color: white; border-radius: 4px;"/>
                    </div>
                </p:dialog>

                <p:confirmDialog global="true" showEffect="fade" hideEffect="fade" responsive="true" width="350">
                    <p:commandButton value="Remove" type="button" styleClass="ui-confirmdialog-yes"/>
                    <p:commandButton value="Cancel" type="button" styleClass="ui-confirmdialog-no ui-button-flat"/>

                </p:confirmDialog>

            </h:form>


            <!-- Side Bar -->
            <div class="card" >  
                <p:sidebar widgetVar="sidebar2" position="right" style="width: 30%; background-color: #f8f9fa; overflow:scroll "  blockScroll= "true">
                    <h:form id ="sidebarForm">
                        <h3>Customize Time Access</h3>
                        <div class="same-line-container">
                            <i class="pi pi-user p-mr-2 text-primary icon-style"></i>
                            <p:outputLabel value="Full Name: " styleClass="label-style" />
                            <h:outputText value="#{assignEntranceBean.selectedEmployee.fullName}" styleClass="value-style" />
                        </div>
                        <br/>
                        <div class="same-line-container" >
                            <i class="fa-solid fa-address-card p-mr-2 text-primary icon-style"></i>
                            <p:outputLabel value="National ID: " styleClass="label-style" />
                            <h:outputText value="#{assignEntranceBean.selectedEmployee.ghanaCardNumber}" styleClass="value-style" />
                        </div>
                        <p:spacer height="20px"/>
                        <div class="same-line-container">
                            <i class="pi pi-building p-mr-2 text-success icon-style"></i>
                            <p:outputLabel value="Entrance:" styleClass="label-style" />
                            <h:panelGroup>
                                <!-- Select Entrance -->
                                <p:autoComplete id="entrance" value="#{assignEntranceBean.selectedEntrance}"
                                                completeMethod="#{assignEntranceBean.employeesEntrances}" 
                                                var="entrance" itemLabel="#{entrance.entranceName}" 
                                                itemValue="#{entrance}"
                                                converter="entranceConverter"
                                                forceSelection="true" dropdown="true"
                                                scrollHeight="200"
                                                placeholder="Search or Select Entrance" 
                                                style="width: 100%;  overflow: hidden">
                                    <p:ajax event="itemSelect" listener="#{assignEntranceBean.prepareCustomTimeRules}" update="timeSettings dayTimeInputs" process="@this" />     
                                </p:autoComplete>
                            </h:panelGroup>
                        </div>

                        <p:separator/>
                        <p:spacer height="30px"/>
                        <!-- Quick Selection Buttons -->
                        <div class="quick-select-buttons" style="margin-bottom: 15px;">
                            <p:commandButton value="Select All" 
                                             icon="pi pi-check-square" 
                                             action="#{assignEntranceBean.selectAllDays}" 
                                             update="daysCheckbox dayTimeInputs" 
                                             process="@this"
                                             styleClass="ui-button-outlined ui-button-sm"
                                             style="margin-right: 8px;" />

                            <p:commandButton value="Weekdays" 
                                             icon="pi pi-briefcase" 
                                             action="#{assignEntranceBean.selectWeekdays}" 
                                             update="daysCheckbox dayTimeInputs" 
                                             process="@this"
                                             styleClass="ui-button-outlined ui-button-sm"
                                             style="margin-right: 8px;" />

                            <p:commandButton value="Weekends" 
                                             icon="pi pi-home" 
                                             action="#{assignEntranceBean.selectWeekends}" 
                                             update="daysCheckbox dayTimeInputs" 
                                             process="@this"
                                             styleClass="ui-button-outlined ui-button-sm"
                                             style="margin-right: 8px;" />

                            <p:commandButton value="Clear All" 
                                             icon="pi pi-times" 
                                             action="#{assignEntranceBean.clearAllDays}" 
                                             update="daysCheckbox dayTimeInputs" 
                                             process="@this"
                                             styleClass="ui-button-outlined ui-button-danger ui-button-sm" />
                        </div>


                        <h:outputLabel value="Select Days" styleClass="day-title"/>
                        <p:outputPanel id="timeSettings">
                            <p:selectManyCheckbox value="#{assignEntranceBean.selectedDays}" layout="grid" columns="3" id="daysCheckbox">
                                <f:selectItem itemLabel="Monday" itemValue="MONDAY" />
                                <f:selectItem itemLabel="Tuesday" itemValue="TUESDAY" />
                                <f:selectItem itemLabel="Wednesday" itemValue="WEDNESDAY" />
                                <f:selectItem itemLabel="Thursday" itemValue="THURSDAY" />
                                <f:selectItem itemLabel="Friday" itemValue="FRIDAY" />
                                <f:selectItem itemLabel="Saturday" itemValue="SATURDAY" />
                                <f:selectItem itemLabel="Sunday" itemValue="SUNDAY" />
                                <p:ajax event="valueChange"
                                        listener="#{assignEntranceBean.loadDayTimeInputs}"
                                        update="dayTimeInputs"
                                        process="@this" />
                            </p:selectManyCheckbox>


                            <p:spacer height="10px"/>

                            <h:panelGroup id="dayTimeInputs" layout="block">
                                <!-- Default Time Section -->
                                <div class="default-time-section" style="margin-bottom: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 8px; border: 1px solid black;">
                                    <h4 style="margin-top: 0; color: #495057; display: flex; align-items: center;">
                                        <i class="pi pi-clock" style="margin-right: 8px; color: #007bff;"></i>
                                        Set Default Time for All Selected Days
                                    </h4>

                                    <p:outputPanel class="default-time-inputs" rendered="#{assignEntranceBean.selectedDays.size()>0}"
                                         style="display: flex; align-items: end; gap: 15px; justify-content: space-between; flex-wrap: wrap;">
                                        <div class="time-group">
                                            <p:outputLabel value="Default Start:" styleClass="default-label" />
                                            <p:datePicker id="defaultStartTime"
                                                          value="#{assignEntranceBean.defaultStartTime}"
                                                          timeOnly="true"
                                                          placeholder="HH:MM"
                                                          pattern="HH:mm"
                                                          hourFormat="12"
                                                          showTime="true"
                                                          showIcon="false"
                                                          stepMinute="1"
                                                          styleClass="small-time-picker" />
                                        </div>

                                        <div class="time-group">
                                            <p:outputLabel value="Default End:" styleClass="default-label" />
                                            <p:datePicker id="defaultEndTime"
                                                          value="#{assignEntranceBean.defaultEndTime}"
                                                          timeOnly="true"
                                                          placeholder="HH:MM"
                                                          pattern="HH:mm"
                                                          hourFormat="12"
                                                          showTime="true"
                                                          showIcon="false"
                                                          stepMinute="1"
                                                          styleClass="small-time-picker" />
                                        </div>

                                        <p:commandButton value="Fill All Selected Days" 
                                                         icon="pi pi-copy" 
                                                         action="#{assignEntranceBean.fillDefaultTimesToSelectedDays}" 
                                                         update="dayTimeInputs" 
                                                         process="@this defaultStartTime defaultEndTime"
                                                         styleClass="ui-button-success ui-button-sm"
                                                         disabled="#{empty assignEntranceBean.selectedDays}" />
                                    </p:outputPanel>
                                </div>

                                <h3 class="section-title">
                                    <i class="pi pi-calendar" style="margin-right:8px;color:#22C55E;" />
                                    Assign CUSTOM Time Range For Days
                                </h3>
                                <ui:repeat value="#{assignEntranceBean.selectedDays}" var="day">
                                    <div class="day-time-block">
                                        <!-- Day label -->
                                        <h:outputText value="#{day}" styleClass="day-title" />
                                        <div class="time-row">
                                            <div class="time-group">
                                                <i class="pi pi-clock" style="color:#6366F1;" />
                                                <p:outputLabel value="Start:" styleClass="label-style" />
                                                <p:datePicker id="startTime"
                                                              value="#{assignEntranceBean.startTimes[day]}"
                                                              timeOnly="true"
                                                              placeholder="HH:MM"
                                                              pattern="HH:mm"
                                                              hourFormat="12"
                                                              showTime="true"
                                                              showIcon="false"
                                                              stepMinute="1"
                                                              styleClass="small-time-picker" />
                                            </div>
                                            <div class="time-group">
                                                <i class="pi pi-clock" style="color:#EF4444;" />
                                                <p:outputLabel value="End:" styleClass="label-style" />
                                                <p:datePicker id="endTime"
                                                              value="#{assignEntranceBean.endTimes[day]}"
                                                              timeOnly="true"
                                                              placeholder="HH:MM"
                                                              pattern="HH:mm"
                                                              hourFormat="12"
                                                              showTime="true"
                                                              showIcon="false"
                                                              stepMinute="1"
                                                              styleClass="small-time-picker" />
                                            </div>
                                            <p:commandButton icon="pi pi-trash" 
                                                             styleClass="rounded-button ui-button-danger ui-button-outlined deletebutton"
                                                             title="Remove this day"
                                                             process="@this"
                                                             actionListener="#{assignEntranceBean.deleteDayTimeTule(day)}"
                                                             update=":sidebarForm:timeSettings :assignEntranceForm:messages" />
                                        </div>
                                    </div><p:separator />
                                    <p:spacer height="10px"/>
                                </ui:repeat>
                            </h:panelGroup>
                        </p:outputPanel>

                        <div class="dialog-footer">
                            <p:commandButton value="Save Rule" icon="pi pi-save" 
                                             action="#{assignEntranceBean.saveDayTimeRules()}"
                                             update="assignEntranceForm :sidebarForm" 
                                             styleClass="save" />
                        </div>
                    </h:form>
                </p:sidebar> 
            </div>
        </div>
        <style>
            .employee-table {
                width: 100%;
                margin-bottom: 20px;
            }
            .search-panel {
                margin-bottom: 20px;
            }
            .entrance-panel {
                margin-top: 20px;
            }
            .ui-dialog {
                width: 50vw !important;
            }
            .assigned-entrances {
                margin-top: 20px;
            }
            .entrance-list {
                margin: 10px 0;
            }
            .entrance-item {
                padding: 5px;
            }
            .remove-button {
                margin-left: 10px;
            }
            .custom-entrances-list .ui-datalist-content,
            .role-entrances-list .ui-datalist-content {
                border: none;
                background: transparent;
            }

            .entrance-item:hover {
                background-color: #f0f0f0 !important;
                transition: background-color 0.2s;
            }

            .ui-dialog {
                width: 50vw !important;
                position: absolute;
            }

            /* Make PrimeFaces Dialog footer stick to bottom */
            .ui-dialog .ui-dialog-content {
                padding-bottom: 60px !important; /* Space for fixed footer */
                position: relative;
                overflow-y: auto;
            }

            /* Handle footer position in dialog */
            .dialog-footer {
                background: #F9FAFB;
                padding: 16px;
                display: flex;
                justify-content: flex-end;
                border-top: 1px solid #E5E7EB;
            }

            /* Hover effect for buttons */
            .action-buttons:hover {
                opacity: 0.9;
                transition: opacity 0.2s;
            }

            /* Scrollbar styling */
            .scrollable-container {
                scrollbar-width: thin;
                scrollbar-color: #aaaaaa #f0f0f0;
            }

            .scrollable-container::-webkit-scrollbar {
                width: 8px;
            }

            .scrollable-container::-webkit-scrollbar-track {
                background: #f0f0f0;
                border-radius: 4px;
            }

            .scrollable-container::-webkit-scrollbar-thumb {
                background-color: #aaaaaa;
                border-radius: 4px;
                border: 2px solid #f0f0f0;
            }

            .scrollable-container::-webkit-scrollbar-thumb:hover {
                background-color: #888888;
            }
        </style>
    </ui:define>
</ui:composition>