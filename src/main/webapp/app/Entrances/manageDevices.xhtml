<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>

<ui:composition template="/WEB-INF/templates.xhtml"
                xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="jakarta.faces.html"
                xmlns:p="http://primefaces.org/ui"
                xmlns:ui="jakarta.faces.facelets"
                xmlns:f="jakarta.faces.core">

    <ui:define name ="title">Manage Entrance Devices</ui:define>

    <ui:define name ="metadata">
        <f:metadata>
            <f:viewAction action="#{deviceBean.setupBreadcrumb()}" />
        </f:metadata>
    </ui:define>

    <ui:define name ="content">
        <h:outputStylesheet library="css" name="manageDevices.css"/>
        <!-- Main Content -->
        <div class="main-content">
            <h:form id="deviceForm">

                <p:growl id="messages" showSummary= "true" showDetail="true" life="6000" />

                <!-- Main Container -->
                <div class="device-container">
                    <!-- Header Section -->
                    <div class="header">
                        <h2><i class="fas fa-microchip"></i> Device Management</h2>
                        <p class="header-subtitle">Manage and configure access control devices</p>
                    </div>

                    <!-- Controls Section -->
                    <div class="controls-section">
                        <div class="controls-grid">
                            <div class="control-group">
                                <h:outputLabel for="deviceId" value="Device ID" styleClass="control-label" />
                                <p:inputText id="deviceId" value="#{deviceBean.device.deviceId}" 
                                             styleClass="modern-input" 
                                             placeholder="Enter device serial/MAC/SSID" />
                            </div>

                            <div class="control-group">
                                <h:outputLabel for="deviceName" value="Device Name" styleClass="control-label" />
                                <p:inputText id="deviceName" value="#{deviceBean.device.deviceName}" 
                                             styleClass="modern-input" 
                                             placeholder="e.g., Main Gate Entry Scanner" />
                            </div>

                            <div class="control-group">
                                <h:outputLabel for="entranceSelect" value="Assign Entrance" styleClass="control-label" />

                                <p:autoComplete id="entranceSelect" 
                                                value="#{deviceBean.selectedEntrance}"
                                                completeMethod="#{deviceBean.searchEntrances}" 
                                                var="e" 
                                                itemLabel="#{e.entranceName}" 
                                                itemValue="#{e}"
                                                converter="entranceConverter"
                                                forceSelection="true" 
                                                dropdown="true"
                                                cache="false"
                                                scrollHeight="200" 
                                                placeholder="Search or Select Entrance"  />
                            </div>

                            <div class="control-group">
                                <h:outputLabel value="Device Position" styleClass="control-label" />
                                <div class="position-toggle" id="positionToggle">
                                    <h:commandButton value="Entry" styleClass="position-option entry #{deviceBean.device.devicePosition == 'ENTRY' ? 'active' : ''}"
                                                     action="#{deviceBean.setDevicePosition('ENTRY')}" 
                                                     onclick="setPositionUI('entry')">
                                        <f:ajax render="positionToggle" />
                                    </h:commandButton>
                                    <h:commandButton value="Exit" styleClass="position-option exit #{deviceBean.device.devicePosition == 'EXIT' ? 'active' : ''}"
                                                     action="#{deviceBean.setDevicePosition('EXIT')}" 
                                                     onclick="setPositionUI('exit')">
                                        <f:ajax render="positionToggle" />
                                    </h:commandButton>
                                </div>
                            </div>

                            <div class="button-group">
                                <h:commandButton value="#{deviceBean.editMode ? 'Update Device' : 'Add Device'}" 
                                                 styleClass="btn btn-primary"
                                                 action="#{deviceBean.saveDevice}">
                                    <f:ajax render="@form" />
                                </h:commandButton>

                                <h:commandButton value="Reset Form" styleClass="btn btn-secondary"
                                                 action="#{deviceBean.reset}"
                                                 rendered="#{not deviceBean.editMode}"
                                                 onclick="resetPositionUI()">
                                    <f:ajax render="@form" />
                                </h:commandButton>

<!--                                <h:commandButton value="Save All" styleClass="btn btn-success"
                                                 action="#-{deviceBean.saveAllDevices}">
                                    <f:ajax render="@form" />
                                </h:commandButton>-->

                                <h:commandButton value="Cancel" 
                                                 styleClass="btn btn-secondary"
                                                 action="#{deviceBean.cancelEdit}"
                                                 rendered="#{deviceBean.editMode}"
                                                 immediate="true">
                                    <f:ajax render="@form" />
                                </h:commandButton>
                            </div>
                        </div>
                    </div>

                    <!-- Content Area with Scrolling -->
                    <div class="content-area">
                        <!-- Devices Section -->
                        <div class="devices-section">
                            <div class="devices-grid">
                                <ui:repeat value="#{deviceBean.filteredDevices}" var="device">
                                    <div class="device-card">
                                        <div class="device-header">
                                            <div class="device-info">
                                                <div class="device-name">#{device.deviceName}</div>
                                                <div class="device-id">#{device.deviceId}</div>
                                            </div>
                                            <div class="device-actions">
                                                <p:commandButton styleClass="btn btn-edit" 
                                                                 action="#{deviceBean.editDevice(device)}"
                                                                 icon="fas fa-edit">
                                                    <f:ajax render="@form" />
                                                </p:commandButton>
                                                <p:commandButton styleClass="btn btn-delete" 
                                                                 action="#{deviceBean.deleteDevice(device)}"
                                                                 onclick="return confirm('Are you sure you want to delete this device?')"
                                                                 icon="fas fa-trash">
                                                    <f:ajax render="@form" />
                                                </p:commandButton>
                                            </div>
                                        </div>

                                        <div class="device-details">
                                            <div class="detail-row">
                                                <span class="detail-label">
                                                    <i class="fas fa-door-open"></i> Entrance
                                                </span>
                                                <h:panelGroup rendered="#{device.entrance != null}">
                                                    <span class="entrance-badge">#{device.entrance.entranceName}</span>
                                                </h:panelGroup>
                                                <h:panelGroup rendered="#{device.entrance == null}">
                                                    <span class="no-entrance-badge">No entrance assigned</span>
                                                </h:panelGroup>
                                            </div>

                                            <div class="detail-row">
                                                <span class="detail-label">
                                                    <i class="fas fa-arrows-alt-h"></i> Position
                                                </span>
                                                <div class="position-toggle">
                                                    <h:commandButton value="Entry" 
                                                                     styleClass="position-option entry #{device.devicePosition == 'ENTRY' ? 'active' : ''}"
                                                                     action="#{deviceBean.updateDevicePosition(device, 'ENTRY')}">
                                                        <f:ajax render="@form" />
                                                    </h:commandButton>
                                                    <h:commandButton value="Exit" 
                                                                     styleClass="position-option exit #{device.devicePosition == 'EXIT' ? 'active' : ''}"
                                                                     action="#{deviceBean.updateDevicePosition(device, 'EXIT')}">
                                                        <f:ajax render="@form" />
                                                    </h:commandButton>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </ui:repeat>

                                <!-- Empty State -->
                                <h:panelGroup rendered="#{empty deviceBean.filteredDevices}">
                                    <div class="empty-state">
                                        <i class="fas fa-microchip"></i>
                                        <h3>No Devices Found</h3>
                                        <p>Add your first device to get started</p>
                                    </div>
                                </h:panelGroup>
                            </div>
                        </div>

                        <!-- Stats Section -->
                        <div class="stats-section">
                            <div class="filter-indicator">
                                <div class="filter-text">
                                    <i class="fas fa-filter"></i> Showing: 
                                    <h:outputText value="All Devices" rendered="#{deviceBean.currentFilter == 'all'}" />
                                    <h:outputText value="Entry Devices" rendered="#{deviceBean.currentFilter == 'entry'}" />
                                    <h:outputText value="Exit Devices" rendered="#{deviceBean.currentFilter == 'exit'}" />
                                    <h:outputText value="Unassigned Devices" rendered="#{deviceBean.currentFilter == 'unassigned'}" />
                                </div>
                            </div>
                            
                            <div class="stats-grid">
                                <h:commandLink styleClass="stat-card #{deviceBean.filterActive('all') ? 'active' : ''}" 
                                               action="#{deviceBean.filterDevices('all')}">
                                    <div class="stat-icon">
                                        <i class="fas fa-microchip"></i>
                                    </div>
                                    <div class="stat-number">#{deviceBean.totalDevices}</div>
                                    <div class="stat-label">Total Devices</div>
                                    <f:ajax render="@form" />
                                </h:commandLink>

                                <h:commandLink styleClass="stat-card #{deviceBean.filterActive('entry') ? 'active' : ''}" 
                                               action="#{deviceBean.filterDevices('entry')}">
                                    <div class="stat-icon">
                                        <i class="fas fa-sign-in-alt"></i>
                                    </div>
                                    <div class="stat-number">#{deviceBean.entryDevices}</div>
                                    <div class="stat-label">Entry Devices</div>
                                    <f:ajax render="@form" />
                                </h:commandLink>

                                <h:commandLink styleClass="stat-card #{deviceBean.filterActive('exit') ? 'active' : ''}" 
                                               action="#{deviceBean.filterDevices('exit')}">
                                    <div class="stat-icon">
                                        <i class="fas fa-sign-out-alt"></i>
                                    </div>
                                    <div class="stat-number">#{deviceBean.exitDevices}</div>
                                    <div class="stat-label">Exit Devices</div>
                                    <f:ajax render="@form" />
                                </h:commandLink>

                                <h:commandLink styleClass="stat-card #{deviceBean.filterActive('unassigned') ? 'active' : ''}" 
                                               action="#{deviceBean.filterDevices('unassigned')}">
                                    <div class="stat-icon">
                                        <i class="fas fa-exclamation-triangle"></i>
                                    </div>
                                    <div class="stat-number">#{deviceBean.unassignedDevices}</div>
                                    <div class="stat-label">Unassigned</div>
                                    <f:ajax render="@form" />
                                </h:commandLink>
                            </div>
                        </div>

                        
                    </div>
                </div>

                <script>
                    function setPositionUI(position) {
                        // Visual feedback for position toggle
                        document.querySelectorAll('.position-toggle .position-option').forEach(opt => {
                            opt.classList.remove('active');
                        });
                        document.querySelector(`.position-option.${position}`).classList.add('active');
                    }

                    function resetPositionUI() {
                        // Clear active class from all position options
                        document.querySelectorAll('.position-toggle .position-option').forEach(opt => {
                            opt.classList.remove('active');
                        });
                    }

                    // Animation on page load
                    document.addEventListener('DOMContentLoaded', function () {
                        const cards = document.querySelectorAll('.device-card');
                        cards.forEach((card, index) => {
                            card.style.animationDelay = `${index * 0.05}s`;
                            card.style.animation = 'fadeInUp 0.4s ease forwards';
                        });
                    });

                    // Add CSS animation
                    const style = document.createElement('style');
                    style.textContent = `
                        @keyframes fadeInUp {
                            from {
                                opacity: 0;
                                transform: translateY(15px);
                            }
                            to {
                                opacity: 1;
                                transform: translateY(0);
                            }
                        }
                    `;
                    document.head.appendChild(style);

                    function filterDevices(type) {
// Remove active class from all cards
                        document.querySelectorAll('.stat-card').forEach(card => {
                            card.classList.remove('active');
                        });

// Add active class to clicked card
                        event.currentTarget.classList.add('active');

// Update filter indicator
                        const filterText = document.querySelector('.filter-text');
                        const filterLabels = {
                            'all': 'All Devices',
                            'entry': 'Entry Devices',
                            'exit': 'Exit Devices',
                            'unassigned': 'Unassigned Devices'
                        };

                        filterText.innerHTML = `<i class="fas fa-filter"></i> Showing: ${filterLabels[type]}`;

// Here you would call your JSF method
                        console.log('Filtering by:', type);
                    }

                </script>
            </h:form>
        </div>
    </ui:define>
</ui:composition>