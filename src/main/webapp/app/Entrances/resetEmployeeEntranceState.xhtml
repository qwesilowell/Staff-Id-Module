<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>

<ui:composition template="/WEB-INF/template2.xhtml"
                xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:p="http://primefaces.org/ui"
                xmlns:ui="jakarta.faces.facelets"
                xmlns:f="jakarta.faces.core">

    <ui:define name="title">Occupant State</ui:define>
    
    <ui:define name ="metadata">
        <f:metadata>
            <f:viewAction action="#{employeeStateBean.setupBreadcrumb()}" />
        </f:metadata>
    </ui:define>

    <ui:define name="content">
        <div class="main-content">
            <h:form id="filterForm">
                <div style="display: flex; justify-content: space-between;">
                <h1>Occupant State Management</h1>
                <div style="margin-top: 20px;">
                <p:commandButton value="Export PDF" 
                                 icon="pi pi-file-pdf" 
                                 styleClass="ui-button-secondary"
                                 ajax="false"
                                 actionListener="#{employeeStateBean.export('PDF')}" />
                </div>
                
                </div>
                
                <p:panel header="Filters" styleClass="custom-panel" toggleable="true">
                    <p:panelGrid columns="4">
                        <p:outputPanel>
                            <p:outputLabel for="@next">Filter based on Employee name</p:outputLabel>
                            <p:autoComplete value="#{employeeStateBean.selectedEmployee}"
                                            completeMethod="#{employeeStateBean.completeEmployees}"
                                            var="emp" itemLabel="#{emp.firstname} #{emp.lastname}" itemValue="#{emp}"
                                            converter="employeeConverter" style="width: 100%; overflow: hidden"
                                             scrollHeight="200"
                                            placeholder="Search Employee..." forceSelection="true"
                                            dropdown="true" />
                        </p:outputPanel>
                        <p:outputPanel>
                            <p:outputLabel for="@next">Filter by Entrance</p:outputLabel>
                            <p:selectOneMenu value="#{employeeStateBean.selectedEntrance}" converter="entranceConverter" style="width: 100%;">
                                <f:selectItem itemLabel="All Entrances" itemValue="#{null}" />
                                <f:selectItems value="#{employeeStateBean.allEntrances}" var="entrance"
                                               itemLabel="#{entrance.entranceName}" itemValue="#{entrance}" />
                            </p:selectOneMenu>
                        </p:outputPanel>
                        <p:outputPanel>
                            <p:outputLabel for="@next">Filter by Employee State</p:outputLabel>
                            <p:selectOneMenu value="#{employeeStateBean.locationStateFilter}" style="width: 100%;">
                                <f:selectItem itemLabel="All States" itemValue="#{null}" />
                                <f:selectItems value="#{employeeStateBean.locationStates}" var="state"
                                               itemLabel="#{state}" itemValue="#{state}" />
                            </p:selectOneMenu>
                        </p:outputPanel>
                    </p:panelGrid>

                    <div style="display: flex; justify-content: space-between;">
                        <p:commandButton value="Reset" action="#{historyBean.reset()}" update="@form" 
                                         icon="fa fa-spinner" iconPos="left" 
                                         styleClass="ui-button-raised ui-button-danger" style="margin-left: 1%"/>
                        <p:commandButton value="Apply Filters" icon="pi pi-filter" action="#{employeeStateBean.applyFilters}"
                                         update=":stateForm:stateTable" 
                                         style="margin-top:10px; display:flex; justify-items:flex-end;"
                                         styleClass="ui-button-raised ui-button-success"/>
                    </div>
                </p:panel>
                <br/><br/>
            </h:form>

            <h:form id="stateForm">
                <p:dataTable id="stateTable"
                             var="state"
                             value="#{employeeStateBean.filteredStates}"
                             paginator="true"
                             paginatorPosition="bottom"
                             rows="10"
                             rowKey="#{state.id}"
                             styleClass="modern-table">

                    <f:facet name="header">
                        <div class="flex align-items-center justify-content-between">
                            <span>MANAGE OCCUPANT STATE</span>
                        </div>
                    </f:facet>

                    <p:column headerText="Full Name" sortBy="#{state.employee.firstname}" styleClass="employee">
                        <div style="font-weight: bold">
                        #{state.employee.firstname} #{state.employee.lastname}
                        </div>
                    </p:column>

                    <p:column headerText="National Id">
                        #{state.employee.ghanaCardNumber}
                    </p:column>

                    <p:column headerText="Entrance">
                        <i class="pi pi-door" style="color:#10B981; margin-right:5px"/> #{state.entrance.entranceName}
                    </p:column>

                    <p:column headerText="State">
                        <h:panelGroup layout="block" style="display: flex; align-items: center;">
                            <i class="pi #{state.currentState == 'INSIDE' ? 'pi-arrow-up' : 'pi-arrow-down'}" 
                               style="color: #{state.currentState == 'INSIDE' ? '#10B981' : '#EF4444'}; margin-right: 6px;" />
                            <h:outputText value="#{state.currentState}" 
                                          style="font-weight: 500; color: #{state.currentState == 'INSIDE' ? '#10B981' : '#EF4444'};" />
                        </h:panelGroup>
                    </p:column>

                    <p:column headerText="Last Updated"> 
                        <h:outputText value="#{state.formattedLastModifiedDate}" />
                    </p:column>

                    <p:column headerText="Updated By">
                        #{state.lastUpdatedBy}
                    </p:column>

                    <p:column headerText="Action" style="width: 150px; text-align:center">
                        <p:commandButton icon="pi pi-sync" title="Reset State"
                                         actionListener="#{employeeStateBean.prepareReset(state)}"
                                         update=":confirmResetDialog"
                                         oncomplete="PF('confirmResetDialogWidget').show()"
                                         styleClass="ui-button-info ui-button-flat"/>
                    </p:column>
                </p:dataTable>
            </h:form>

            <p:dialog header="Confirm Reset" widgetVar="confirmResetDialogWidget" modal="true"
                      id="confirmResetDialog" closable="false" resizable="false" width="400">
                <h:form id="confirmForm">
                    <p:outputPanel rendered="#{not empty employeeStateBean.selectedState}">
                        <p:outputLabel value="Change state for #{employeeStateBean.selectedState.employee.firstname} to:"/><br/>
                        <p:selectOneMenu value="#{employeeStateBean.newState}" style="margin-top: 10px;">
                            <f:selectItem itemLabel="Select State" itemValue="" noSelectionOption="true"/>
                            <f:selectItem itemLabel="INSIDE" itemValue="INSIDE"/>
                            <f:selectItem itemLabel="OUTSIDE" itemValue="OUTSIDE"/>
                        </p:selectOneMenu>

                        <p:inputTextarea value="#{employeeStateBean.resetReason}" placeholder="Reason..." autoResize="true" style="margin-top: 10px; width: 100%"/>

                        <div style="margin-top: 15px;">
                            <p:commandButton value="Confirm Reset" icon="pi pi-check"
                                             action="#{employeeStateBean.confirmReset}"
                                             update=":stateForm:stateTable"
                                             process="@form"
                                             oncomplete="PF('confirmResetDialogWidget').hide()"
                                             styleClass="ui-button-success"/>

                            <p:commandButton value="Cancel" icon="pi pi-times"
                                             onclick="PF('confirmResetDialogWidget').hide()"
                                             type="button"
                                             styleClass="ui-button-secondary" style="margin-left: 10px;"/>
                        </div>
                    </p:outputPanel>
                </h:form>
            </p:dialog>
        </div>

    </ui:define>
</ui:composition>
