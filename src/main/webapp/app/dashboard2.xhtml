<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>

<ui:composition template="/WEB-INF/templates.xhtml"
                xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="jakarta.faces.html"
                xmlns:f="jakarta.faces.core"
                xmlns:p="http://primefaces.org/ui"
                xmlns:ui="jakarta.faces.facelets">


    <ui:define name ="title">System Dashboard</ui:define>
    <ui:define name ="content">
        <!-- Main Content -->
        <div class="main-content" >
            <p:growl widgetVar="fgrowl" id="growl" showSummary= "true" showDetail="true" life="6000" globalOnly="true"/>

            <h1> Dashboard Content </h1>
            <h:form id="dashboardForm" prependId="false">
                <p:tabView activeIndex="#{sessionScope.userRole == 'Admin' ? 0 : 1}">
                    <!-- Admin Dashboard -->
                    <p:tab title="Admin Dashboard" rendered="#{sessionScope.userRole == 'Admin'}">
                        <p:panelGrid columns="1" styleClass="ui-panelgrid">
                            <ul class="insights">
                                <li>
                                    <i class='bx pi pi-users !text-[30px]'></i>
                                    <span class="info">
                                        <h3 class="!text-left">#{dashboard2.totalEmployees}</h3>
                                        <p>Total Employees</p>
                                    </span>
                                </li>
                                <li>
                                    <i class='bx fa fa-user-tie !text-[30px]'></i>
                                    <span class="info">
                                        <h3 class="!text-left">#{dashboard2.totalRoles}</h3>
                                        <p>Total Roles</p>
                                    </span>
                                </li>
                                <li>
                                    <i class='bx fa-solid fa-door-open !text-[30px]'></i>
                                    <span class="info">
                                        <h3 class="!text-left">#{dashboard2.totalEntrances}</h3>
                                        <p>Total Entrances</p>
                                    </span>
                                </li>
                                <li>
                                    <i class='bx fa-regular fa-calendar !text-[30px]'></i>
                                    <span class="info">
                                        <h3 class="!text-left">#{dashboard2.employeesOnboardedMonth}</h3>
                                        <p>Onboarded This Month</p>
                                    </span>
                                </li>
                                <li>
                                    <i class='bx fa-regular fa-circle-check !text-[30px]'></i>
                                    <span class="info">
                                        <h3 class="!text-left">#{dashboard2.successfulLoginsToday}</h3>
                                        <p>Successful logins Today</p>
                                    </span>
                                </li>
                                <!--                            <li>
                                                                <i class='bx pi pi-dollar !text-[30px]'></i>
                                                                <span class="info">
                                                                    <h3 class="!text-left">#{dashboard2.employeesOnboardedToday}</h3>
                                                                    <p>Onboarded Today</p>
                                                                </span>
                                                            </li>
                                                            
                                                            <li>
                                                                <i class='bx pi pi-dollar !text-[30px]'></i>
                                                                <span class="info">
                                                                    <h3 class="!text-left">#{dashboard2.employeesOnboardedWeek}</h3>
                                                                    <p>Onboarded This Week</p>
                                                                </span>
                                                            </li>
                                                         
                                                        
                                                            <li>
                                                                <i class='bx pi pi-dollar !text-[30px]'></i>
                                                                <span class="info">
                                                                    <h3 class="!text-left">#{dashboard2.verificationSuccessRate}%</h3>
                                                                    <p>Verification Success Rate</p>
                                                                </span>
                                                            </li>                    -->
                                <!--                            <li>
                                                                <i class='bx pi pi-dollar !text-[30px]'></i>
                                                                <span class="info">
                                                                    <h3 class="!text-left">#{dashboard2.accessSuccessRate}%</h3>
                                                                    <p>Entrance Access Success Rate</p>
                                                                </span>
                                                            </li>-->

                            </ul>
                        </p:panelGrid>
                        <!--
                        
                        <p:panelGrid columns="3" styleClass="ui-panelgrid">
                            <p:panel styleClass="dashboard-card">
                                <h:outputText value="Total Employees" styleClass="card-title"/>
                                <h:outputText value="#{dashboard2.totalEmployees}" styleClass="card-value"/>
                            </p:panel>
                            <p:panel styleClass="dashboard-card">
                                <h:outputText value="Total Roles" styleClass="card-title"/>
                                <h:outputText value="#{dashboard2.totalRoles}" styleClass="card-value"/>
                            </p:panel>
                            <p:panel styleClass="dashboard-card">
                                <h:outputText value="Total Entrances" styleClass="card-title"/>
                                <h:outputText value="#{dashboard2.totalEntrances}" styleClass="card-value"/>
                            </p:panel>
                            <p:panel styleClass="dashboard-card">
                                <h:outputText value="Onboarded Today" styleClass="card-title"/>
                                <h:outputText value="#{dashboard2.employeesOnboardedToday}" styleClass="card-value"/>
                            </p:panel>
                            <p:panel styleClass="dashboard-card">
                                <h:outputText value="Onboarded This Week" styleClass="card-title"/>
                                <h:outputText value="#{dashboard2.employeesOnboardedWeek}" styleClass="card-value"/>
                            </p:panel>
                            <p:panel styleClass="dashboard-card">
                                <h:outputText value="Onboarded This Month" styleClass="card-title"/>
                                <h:outputText value="#{dashboard2.employeesOnboardedMonth}" styleClass="card-value"/>
                            </p:panel>
                            <p:panel styleClass="dashboard-card">
                                <h:outputText value="Successful Logins Today" styleClass="card-title"/>
                                <h:outputText value="#{dashboard2.successfulLoginsToday}" styleClass="card-value"/>
                            </p:panel>
                            <p:panel styleClass="dashboard-card">
                                <h:outputText value="Verification Success Rate" styleClass="card-title"/>
                                <h:outputText value="#{dashboard2.verificationSuccessRate}%"/>
                            </p:panel>
                            <p:panel styleClass="dashboard-card">
                                <h:outputText value="Access Success Rate" styleClass="card-title"/>
                                <h:outputText value="#{dashboard2.accessSuccessRate}%"/>
                            </p:panel>
                        </p:panelGrid>-->

                        <!--                        <p:panel styleClass="filter-container" style="bor">-->

                        <h:outputText value="Filter by Entrance: "/>
                        <p:selectOneMenu value="#{dashboard2.selectedEntranceId}">
                            <f:selectItem itemLabel="All Entrances" itemValue="#{null}"/>
                            <f:selectItems value="#{dashboard2.allEntrances}" var="e" itemLabel="#{e.entrance_Name}" itemValue="#{e.entrance_Device_ID}"/>
                            <p:ajax update="dashboardContent" listener="#{dashboard2.updateStats}" process="@this"/>
                        </p:selectOneMenu>

                        <h:panelGroup id="dashboardContent" layout="block">
                            <p:spacer height="20px"/>
                            <p:panel header="Recent Entrance Access Attempts">
                                <p:dataTable value="#{dashboard2.recentAccessAttempts}" var="log" rowIndexVar="rowIndex"  rowStyleClass="#{rowIndex mod 2 eq 0 ? 'white-row' : 'ash-row'}">  
                                    <p:column headerText="Employee">
                                        <h:outputText value="#{dashboard2.getEmployeeNameFromMap(log.employee)}"/>
                                    </p:column>
                                    <p:column headerText="GhanaCard No">
                                        <h:outputText value="#{log.employee.ghanaCardNumber}"/>
                                    </p:column>
                                    <p:column headerText="Entrance">
                                        <h:outputText value="#{dashboard2.getEntranceName(log.entranceId)}"/>
                                    </p:column>
                                    <p:column headerText="Result">
                                        <h:outputText value="#{log.result.toUpperCase()}"
                                                      styleClass="#{log.result eq 'granted' ? 'granted-box' : 'denied-box'}" />

                                    </p:column>
                                    <p:column headerText="Time">
                                        <h:outputText value="#{dashboard2.getFormattedTimestamp(log)}">

                                        </h:outputText>
                                    </p:column>
                                </p:dataTable>
                            </p:panel>
                        </h:panelGroup>

                        <!--                        </p:panel>-->
                        <p:panelGrid columns="2"> 
                            <p:panel header="Roles With Most Employees">
                                <p:pieChart model="#{dashboard2.rolePieChartModel}" style="height: 400px;" />
                            </p:panel>


                            <p:panel header="Entrance Access Count ">
                                <h:outputText value="Filter by Entrance: "/>
                                <p:selectOneMenu value="#{dashboard2.selectedEntranceId}">
                                    <f:selectItem itemLabel="All Entrances" itemValue="#{null}"/>
                                    <f:selectItems value="#{dashboard2.allEntrances}" var="e" itemLabel="#{e.entrance_Name}" itemValue="#{e.entrance_Device_ID}"/>
                                    <p:ajax update="entanceAccessChart" listener="#{dashboard2.entranceaccessupdate()}" process="@this"/>
                                </p:selectOneMenu>

                                <p:outputPanel id="entanceAccessChart" style="align-items:center">

                                    <p:barChart model="#{dashboard2.barChartModelEntrance}" style=" width:50px; height: 400px;" />
                                </p:outputPanel>

                            </p:panel>

                            <p:panel header="Top 5 Most Accessed Entrances (Granted Only)">
                                <p:lineChart model="#{dashboard2.topEntrancesChartModel}" style="height: 300px;" />
                            </p:panel>


                            <!--                            <p:panel styleClass="chart-container">
                                                            <p:chart model="#-{dashboard2.onboardedBarChart}" style="width:600px;height:300px"/>
                                                        </p:panel>
                                                        <p:panel styleClass="chart-container">
                                                            <p:chart model="#-{dashboard2.loginTrendChart}" style="width:600px;height:300px"/>
                                                        </p:panel>-->
                        </p:panelGrid>

                        <p:spacer height="10px"/>

                        <p:panel id="dashboardContent2">


                            <p:panel header="Recent Employees Added">
                                <p:dataTable value="#{dashboard2.recentEmployees}" var="emp">
                                    <p:column headerText="Name"><h:outputText value="#{emp.firstname} #{emp.lastname}"/></p:column>
                                    <p:column headerText="Onboarded">
                                        <h:outputText value="#{emp.createdAt}">
                                            <f:convertDateTime pattern="yyyy-MM-dd HH:mm:ss"/>
                                        </h:outputText>
                                    </p:column>
                                </p:dataTable>
                            </p:panel>

                            <p:spacer height="30px"/>


                            <p:panel header="Roles with Most Employees">
                                <p:dataTable value="#{dashboard2.rolesWithMostEmployees}" var="role">
                                    <p:column headerText="Role"><h:outputText value="#{role.roleName}"/></p:column>
                                    <p:column headerText="Employees"><h:outputText value="#{role.count}"/></p:column>
                                </p:dataTable>
                            </p:panel>

                            <p:spacer height="30px"/>
                            <p:panel header="Recent Successful Logins">
                                <p:dataTable value="#{dashboard2.recentLogins}" var="log">
                                    <p:column headerText="User"><h:outputText value="#{log.userId}"/></p:column>
                                    <p:column headerText="Time"><h:outputText value="#{dashboard2.getFormattedActivityLogTimestamp(log)}"/></p:column>
                                    <p:column headerText="Details"><h:outputText value="#{log.details}"/></p:column>
                                </p:dataTable>
                            </p:panel>


                            <p:spacer height="30px"/>



                        </p:panel>
                    </p:tab>

                    <!-- User Dashboard -->
                    <p:tab title="User Dashboard">
                        <p:panelGrid columns="1" styleClass="ui-panelgrid">
                            <ul class="insights">
                                <li>
                                    <i class='bx pi pi-users !text-[30px]'></i>
                                    <span class="info">
                                        <h3 class="!text-left">#{dashboard2.totalEmployees}</h3>
                                        <p>Total Employees</p>
                                    </span>
                                </li>
                                <li>
                                    <i class='bx fa fa-user-tie !text-[30px]'></i>
                                    <span class="info">
                                        <h3 class="!text-left">#{dashboard2.totalRoles}</h3>
                                        <p>Total Roles</p>
                                    </span>
                                </li>
                                <li>
                                    <i class='bx fa-solid fa-door-open !text-[30px]'></i>
                                    <span class="info">
                                        <h3 class="!text-left">#{dashboard2.totalEntrances}</h3>
                                        <p>Total Entrances</p>
                                    </span>
                                </li>
                                <li>
                                    <i class='bx fa-regular fa-calendar !text-[30px]'></i>
                                    <span class="info">
                                        <h3 class="!text-left">#{dashboard2.employeesUserOnboardedToday}</h3>
                                        <p>Employees Onboarded Today</p>
                                    </span>
                                </li>
                            </ul>
                            <!--                            <p:panel styleClass="dashboard-card">
                                                            <h:outputText value="Your Logins Today" styleClass="card-title"/>
                                                            <h:outputText value="#-{dashboard2.userSuccessfulLoginsToday}" styleClass="card-value"/>
                                                        </p:panel>
                                                        <p:spacer height="30px"/>-->



                            <p:panel styleClass="dashboard-card">
                                <h:outputText value="Access Success Rate " styleClass="card-title"/>
                                <p:spacer height="10px"/>
                                <h:outputText value="#{dashboard2.accessSuccessRate}%"/>
                            </p:panel>
                        </p:panelGrid>

                        <h:outputText value="Filter by Entrance: "/>
                        <p:selectOneMenu value="#{dashboard2.selectedEntranceId}">
                            <f:selectItem itemLabel="All Entrances" itemValue="#{null}"/>
                            <f:selectItems value="#{dashboard2.allEntrances}" var="e" itemLabel="#{e.entrance_Name}" itemValue="#{e.entrance_Device_ID}"/>
                            <p:ajax update="dashboardContentU" listener="#{dashboard2.updateStats}" process="@this"/>
                        </p:selectOneMenu>

                        <h:panelGroup id="dashboardContentU" layout="block">
                            <p:spacer height="20px"/>
                            <p:panel header="Recent Entrance Access Attempts">
                                <p:dataTable value="#{dashboard2.recentAccessAttempts}" var="log" rowIndexVar="rowIndex"  rowStyleClass="#{rowIndex mod 2 eq 0 ? 'white-row' : 'ash-row'}">  
                                    <p:column headerText="Employee">
                                        <h:outputText value="#{dashboard2.getEmployeeNameFromMap(log.employee)}"/>
                                    </p:column>
                                    <p:column headerText="GhanaCard No">
                                        <h:outputText value="#{log.employee.ghanaCardNumber}"/>
                                    </p:column>
                                    <p:column headerText="Entrance">
                                        <h:outputText value="#{dashboard2.getEntranceName(log.entranceId)}"/>
                                    </p:column>
                                    <p:column headerText="Result">
                                        <h:outputText value="#{log.result}"
                                                      styleClass="#{log.result eq 'granted' ? 'granted-box' : 'denied-box'}" />

                                    </p:column>
                                    <p:column headerText="Time">
                                        <h:outputText value="#{dashboard2.getFormattedTimestamp(log)}">

                                        </h:outputText>
                                    </p:column>
                                </p:dataTable>
                            </p:panel>
                        </h:panelGroup>

                        <p:spacer height="30px"/>

                        <p:panel header="Your Assigned Entrances">
                            <p:dataTable value="#{dashboard2.userAssignedEntrances}" var="entrance">
                                <p:column headerText="Entrance Name"><h:outputText value="#{entrance.entrance_Name}"/></p:column>
                                <p:column headerText="Location"><h:outputText value="#{entrance.entrance_Location}"/></p:column>
                            </p:dataTable>
                        </p:panel>
                        <p:spacer height="30px"/>
                        <p:panel header="Employees You Recently Onboarded">
                            <p:dataTable value="#{dashboard2.userRecentEmployees}" var="emp">
                                <p:column headerText="Name"><h:outputText value="#{emp.firstname} #{emp.lastname}"/></p:column>
                                <p:column headerText="Onboarded">
                                    <h:outputText value="#{emp.createdAt}">
                                        <f:convertDateTime pattern="yyyy-MM-dd HH:mm:ss"/>
                                    </h:outputText>
                                </p:column>
                            </p:dataTable>
                        </p:panel>
                        <p:spacer height="30px"/>

                        <p:panel header="Your Recent Access Attempts">
                            <p:dataTable value="#{dashboard2.userRecentAccessAttempts}" var="log">
                                <p:column headerText="Entrance"><h:outputText value="#{log.entranceId}"/></p:column>
                                <p:column headerText="Result"><h:outputText value="#{log.result}"/></p:column>
                                <p:column headerText="Time"><h:outputText value="#{log.timestamp}"/></p:column>
                                <p:column headerText="Verification Time"><h:outputText value="#{log.verificationTime} sec"/></p:column>
                            </p:dataTable>
                        </p:panel>
                    </p:tab>
                </p:tabView>
            </h:form>

        </div>
        <script target="head" src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
        <style>
            body .ui-panel .ui-panel-titlebar{
                background: #2196f3;
                color: white;

            }
            .dashboard-card {
                background: #f8f9fa;
                border-radius: 8px;
                padding: 20px;
                margin: 10px;
                text-align: center;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            .card-title {
                font-size: 1.2em;
                color: #333;
                margin-bottom: 10px;
            }
            .card-value {
                font-size: 2em;
                color: #007bff;
            }

            .chart-container {
                margin: 20px;
                padding: 20px;
            }
            .filter-container {
                margin: 10px;
            }

            .insights{
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
                grid-gap: 24px;
                margin-top: 36px;
            }

            .insights li{
                padding: 24px;
                background: #f6f6f9;
                border-radius: 20px;
                display: flex;
                align-items: center;
                grid-gap: 24px;
            }

            .insights li .bx{
                width: 80px;
                height: 80px;
                border-radius: 10px;
                font-size: 36px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .insights li:nth-child(1) .bx{
                background: #CFE8FF;
                color: #1976D2;
            }

            .insights li:nth-child(2) .bx{
                background: #FFF2C6;
                color: #183153;
            }

            .insights li:nth-child(3) .bx{
                background: #BBF7D0;
                color: #388E3C;
            }

            .insights li:nth-child(4) .bx{
                background: #FECDD3;
                color: #D32F2F;
            }
            .insights li:nth-child(5) .bx{
                background: #cfff00;
                color: #425e9e;
            }

            .insights li:nth-child(6) .bx{
                background: #9A98EA;
                color: #D32F2F;
            }
            .insights li:nth-child(6) .bx{
                background: #9A98EA;
                color: #D32F2F;
            }
            .insights li:nth-child(7) .bx{
                background: #BBF7D0;
                color: #D32F2F;
            }
            .insights li:nth-child(8) .bx{
                background: #BBF7D0;
                color: #D32F2F;
            }
            .insights li:nth-child(9) .bx{
                background: #BBF7D0;
                color: #D32F2F;
            }
            .insights li .info h3{
                font-size: 24px;
                font-weight: 600;
                color: #363949;
            }

            .insights li .info p{
                color: #363949;
            }
            .granted-box {
                background-color: #d4edda; /* light green */
                color: black;
                padding: 4px 8px;
                border-radius: 5px;
                font-weight: bold;
                display: inline-block;
            }

            .denied-box {
                background-color: #dc143c ; /* red */
                color: white;
                padding: 4px 8px;
                border-radius: 5px;
                font-weight: bold;
                display: inline-block;
            }
            .white-row {
                background-color: white !important;
            }

            .ash-row {
                background-color: #f0f0f0 !important; 
            }
            .white-row:hover, .ash-row:hover {
                background-color: #dceeff !important;
                cursor: pointer;
            }
        </style>
    </ui:define>
</ui:composition>


