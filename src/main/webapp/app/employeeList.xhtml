<?xml version="1.0" encoding="UTF-8"?>

<ui:composition template="/WEB-INF/template2.xhtml"
                xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="jakarta.faces.html"
                xmlns:f="jakarta.faces.core"
                xmlns:p="http://primefaces.org/ui"
                xmlns:ui="jakarta.faces.facelets">

    <ui:define name="metadata">
        <f:metadata>
            <f:viewAction action="#{manageEmployeesBean.setupBreadcrumb}" />
        </f:metadata>
    </ui:define>

    <ui:define name ="title">Employee List</ui:define>
    <ui:define name="head">
        <h:outputStylesheet library="css" name="manageEmployee.css"/>
    </ui:define>

    <ui:define name ="content">
        <!-- Main Content -->
        <div class="main-content" >
            <h1>Employee Profiles</h1>
            <h:form id="employeeForm">
                <h:panelGroup layout="block" style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                    <p:growl widgetVar="fgrowl" id="growl" showSummary= "false" showDetail="true" life="6000" globalOnly="false"/>
                    <!-- Search Bar on the Left --> 
                    <p:inputText id="search" value="#{manageEmployeesBean.searchQuery}"
                                 placeholder="Search by Name or Ghana Card"
                                 styleClass="search-box"
                                 style="flex: 1; max-width: 300px;">
                        <p:ajax event="keyup" listener="#{manageEmployeesBean.findEmployee}" update="employeeTable"/>
                    </p:inputText>

                    <!-- Add New Employee Button on the Right -->
                    <p:commandButton value="Add New Employee" icon="pi pi-plus" action="#{manageEmployeesBean.goToSignup}" 
                                     ajax="false" style="font-size: 1em; background-color: #FFF8E1; color: black; margin-left: auto;" />
                </h:panelGroup>

                <p:spacer height="30px"/>


                <!-- Employee List -->
                <p:dataTable id="employeeTable" value="#{manageEmployeesBean.employees}" var="employee" 
                             paginator="true" paginatorPosition="bottom" rows="10"  rowIndexVar="rowIndex"  rowStyleClass="#{rowIndex mod 2 eq 0 ? 'white-row' : 'ash-row'}">

                    <p:column headerText="Full Name">
                        <div style="font-weight: bold">
                        <h:outputText value="#{employee.fullName}" />
                        </div>
                    </p:column>

                    <p:column headerText="National ID">
                        <h:outputText value="#{employee.ghanaCardNumber}" />
                    </p:column>
                    
                    <p:column headerText="Role">
                        <h:outputText value="#{employee.role}" />
                    </p:column>

                    <p:column headerText="Email">
                        <h:outputText value="#{employee.email}" />
                    </p:column>

                    <p:column headerText="Actions">
                        <p:commandButton value="View" icon="pi pi-eye" id="profileBtn"
                                         action="#{manageEmployeesBean.viewEmployee(employee.ghanaCardNumber)}" 
                                         update=":employeeForm:profileModal :sidebarForm"
                                         oncomplete="PF('profileDialog').show();" />
                    </p:column>
                </p:dataTable>
                <!-- Profile Modal -->
                <p:dialog id="profileModal" 
                          widgetVar="profileDialog"
                          responsive="true"
                          modal="true" 
                          blockScroll= "true" >

                    <div class="modal-overlay">
                        <div class="profile-modal">
                            <div class="modal-header">
                                <h2 class="modal-title">Profile</h2>
                                <button class="close-button" id="closeModal">×</button>
                            </div>

                            <div class="profile-content">
                                <div class="user-profile">
                                    <div class="profile-avatar"><strong>#{manageEmployeesBean.selectedEmployeeInitials}</strong></div>
                                    <h1 class="user-name">#{manageEmployeesBean.selectedEmployee.fullName}</h1>
                                    <div class="user-email" style="display: flex; justify-content: space-between">
                                        <div style="margin-right: 3px">
                                            • #{manageEmployeesBean.selectedEmployee.email}
                                        </div>
                                        <div>
                                            • #{manageEmployeesBean.selectedEmployee.primaryPhone}
                                        </div>
                                    </div>
                                    <h3 class = "gh-no">#{manageEmployeesBean.selectedEmployee.ghanaCardNumber}</h3>
                                    <p class="user-bio">
                                        #{manageEmployeesBean.selectedEmployee.role} <span class="user-empstat">(#{manageEmployeesBean.selectedEmployee.employmentStatus})</span>
                                    </p>
                                </div>

                                <div class="divider"></div>


                                <div class="profile-section">
                                    <div style="display: flex; align-items: center; gap: 8px">
                                        <i class="fa-solid fa-door-open" ></i>
                                        <h3 class="section-title" style="margin: 0;">Entrance Details</h3>
                                    </div>
                                    <div class="profile-actions">
                                        <h:commandButton value=" Default Entrances"
                                                         action="#{manageEmployeesBean.toggleEntrances}"
                                                         styleClass="action-buttons">
                                            <f:ajax render="entrancesPanel" />
                                        </h:commandButton>

                                    </div>

                                    <h:panelGroup id="entrancesPanel">
                                        <h:panelGroup rendered="#{manageEmployeesBean.showEntrances}"
                                                      styleClass="skill-tags"
                                                      style="margin-top: 10px;">
                                            <ui:repeat value="#{manageEmployeesBean.selectedEmployeeEntrances}" var="entrance">
                                                <span class="skill-tag">#{entrance.entranceName}</span>
                                            </ui:repeat>
                                            <h:outputText value="No entrances assigned" rendered="#{empty manageEmployeesBean.selectedEmployeeEntrances}" />
                                        </h:panelGroup>
                                    </h:panelGroup>
                                    <p:spacer height="10px"/>


                                    <div class="profile-actions">
                                        <h:commandButton value=" Custom Entrances"
                                                         action="#{manageEmployeesBean.toggleCustomEntrances}"
                                                         styleClass="action-buttons">
                                            <f:ajax render="CustomEntrancesPanel" />
                                        </h:commandButton>

                                    </div>

                                    <h:panelGroup id="CustomEntrancesPanel">
                                        <h:panelGroup rendered="#{manageEmployeesBean.showCustomEntrances}"
                                                      styleClass="skill-tags"
                                                      style="margin-top: 10px;">
                                            <ui:repeat value="#{manageEmployeesBean.selectedCustomEmpEntrances}" var="entrance">
                                                <span class="skill-tag">#{entrance.entranceName}</span>
                                            </ui:repeat>
                                            <br/>
                                            <h:outputText value="No Custom entrances assigned" rendered="#{empty manageEmployeesBean.selectedCustomEmpEntrances}" />
                                        </h:panelGroup>
                                    </h:panelGroup>
                                </div>
                                <div class="divider"></div>

                                <!-- Time Access Info  and Customization-->
                                <div class="profile-section">
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <i class="fa-regular fa-clock"></i>
                                        <h3 class="section-title" style="margin: 0;">Custom Time Access Details</h3>
                                    </div>                                   
                                    <div class="profile-actions">
                                        <p:commandButton value="Create Customized Time Access"
                                                         icon=" pi pi-cog"
                                                         update=":sidebarForm"
                                                         oncomplete="PF('sidebar2').show();PF('profileDialog').hide();"
                                                         styleClass="icon-expand-btn mr-2" />
                                    </div>
                                </div>
                            </div>

                            <div class="delete">
                                <p:commandButton value="Want to delete this employee account? Click here" 
                                                 styleClass="del-statement" 
                                                 process="@this" 
                                                 oncomplete="PF('deleteEmployeeDialog').show()" 
                                                 />
                            </div>
                            <button class="primary-button" onclick="PF('profileDialog').hide();">Close</button>
                        </div>
                    </div>
                </p:dialog>

                <p:dialog id="deleteEmployeeDialog" 
                          widgetVar="deleteEmployeeDialog" 
                          header="Confirm Deletion" 
                          modal="true" 
                          showEffect="fade" 
                          hideEffect="fade" 
                          resizable="false" 
                          width="300"
                          style="color:#9ca3af">
                    <h:panelGroup>
                        <h:outputText value="Are you sure you want to delete employee?" />
                    </h:panelGroup>              
                    <br/>
                    <br/>
                    <br/>
                    <div style="display:flex; flex-direction: row; justify-content: flex-end; gap: 10px;">
                        <p:commandButton value="Yes" 
                                         icon="pi pi-check" 
                                         action="#{manageEmployeesBean.deleteEmployee}" 
                                         update=":employeeForm:employeeTable :employeeForm:growl" 
                                         oncomplete="PF('deleteEmployeeDialog').hide(); PF('profileDialog').hide();" 
                                         styleClass="" />

                        <p:commandButton value="No" 
                                         type="button" 
                                         icon="pi pi-times" 
                                         onclick="PF('deleteEmployeeDialog').hide();" 
                                         styleClass="ui-button-secondary" />
                    </div>
                </p:dialog>
            </h:form>
            <!-- Side Bar -->
            <div class="card" >  
                <p:sidebar widgetVar="sidebar2" position="right" style="width: 30%; background-color: #f8f9fa; overflow:scroll "  blockScroll= "true">
                    <h:form id ="sidebarForm">
                        <h3>Customize Time Access</h3>
                        <div class="same-line-container">
                            <i class="pi pi-user p-mr-2 text-primary icon-style"></i>
                            <p:outputLabel value="Full Name: " styleClass="label-style" />
                            <h:outputText value="#{manageEmployeesBean.selectedEmployee.fullName}" styleClass="value-style" />
                        </div>
                        <br/>
                        <div class="same-line-container" >
                            <i class="fa-solid fa-address-card p-mr-2 text-primary icon-style"></i>
                            <p:outputLabel value="National ID: " styleClass="label-style" />
                            <h:outputText value="#{manageEmployeesBean.selectedEmployee.ghanaCardNumber}" styleClass="value-style" />
                        </div>
                        <p:spacer height="20px"/>
                        <div class="same-line-container">
                            <i class="pi pi-building p-mr-2 text-success icon-style"></i>
                            <p:outputLabel value="Entrance:" styleClass="label-style" />
                            <h:panelGroup>
                                <!-- Select Entrance -->
                                <p:autoComplete id="entrance" value="#{manageEmployeesBean.selectedEntrance}"
                                                completeMethod="#{manageEmployeesBean.employeesEntrances}" 
                                                var="entrance" itemLabel="#{entrance.entranceName}" 
                                                itemValue="#{entrance}"
                                                converter="entranceConverter"
                                                forceSelection="true" dropdown="true"
                                                scrollHeight="200"
                                                placeholder="Search or Select Entrance" 
                                                style="width: 100%;  overflow: hidden">
                                    <p:ajax event="itemSelect" listener="#{manageEmployeesBean.prepareCustomTimeRules}" update="timeSettings dayTimeInputs" process="@this" />     
                                </p:autoComplete>
                            </h:panelGroup>
                        </div>

                        <p:separator/>
                        <p:spacer height="30px"/>
                        <!-- Quick Selection Buttons -->
                        <div class="quick-select-buttons" style="margin-bottom: 15px;">
                            <p:commandButton value="Select All" 
                                             icon="pi pi-check-square" 
                                             action="#{manageEmployeesBean.selectAllDays}" 
                                             update="daysCheckbox dayTimeInputs" 
                                             process="@this"
                                             styleClass="ui-button-outlined ui-button-sm"
                                             style="margin-right: 8px;" />

                            <p:commandButton value="Weekdays" 
                                             icon="pi pi-briefcase" 
                                             action="#{manageEmployeesBean.selectWeekdays}" 
                                             update="daysCheckbox dayTimeInputs" 
                                             process="@this"
                                             styleClass="ui-button-outlined ui-button-sm"
                                             style="margin-right: 8px;" />

                            <p:commandButton value="Weekends" 
                                             icon="pi pi-home" 
                                             action="#{manageEmployeesBean.selectWeekends}" 
                                             update="daysCheckbox dayTimeInputs" 
                                             process="@this"
                                             styleClass="ui-button-outlined ui-button-sm"
                                             style="margin-right: 8px;" />

                            <p:commandButton value="Clear All" 
                                             icon="pi pi-times" 
                                             action="#{manageEmployeesBean.clearAllDays}" 
                                             update="daysCheckbox dayTimeInputs" 
                                             process="@this"
                                             styleClass="ui-button-outlined ui-button-danger ui-button-sm" />
                        </div>

                        <h:outputLabel value="Select Days" styleClass="day-title"/>
                        
                        <p:outputPanel id="timeSettings">
                            <p:selectManyCheckbox value="#{manageEmployeesBean.selectedDays}" layout="grid" columns="3" id="daysCheckbox">
                                <f:selectItem itemLabel="Monday" itemValue="MONDAY" />
                                <f:selectItem itemLabel="Tuesday" itemValue="TUESDAY" />
                                <f:selectItem itemLabel="Wednesday" itemValue="WEDNESDAY" />
                                <f:selectItem itemLabel="Thursday" itemValue="THURSDAY" />
                                <f:selectItem itemLabel="Friday" itemValue="FRIDAY" />
                                <f:selectItem itemLabel="Saturday" itemValue="SATURDAY" />
                                <f:selectItem itemLabel="Sunday" itemValue="SUNDAY" />
                                <p:ajax event="valueChange"
                                        listener="#{manageEmployeesBean.loadDayTimeInputs}"
                                        update="dayTimeInputs"
                                        process="@this" />
                            </p:selectManyCheckbox>


                            <p:spacer height="10px"/>

                            <h:panelGroup id="dayTimeInputs" layout="block">
                                <!-- Default Time Section -->
                                <div class="default-time-section" style="margin-bottom: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 8px; border: 1px solid black;">
                                    <h4 style="margin-top: 0; color: #495057; display: flex; align-items: center;">
                                        <i class="pi pi-clock" style="margin-right: 8px; color: #007bff;"></i>
                                        Set Default Time for All Selected Days
                                    </h4>

                                    <p:outputPanel class="default-time-inputs" rendered="#{manageEmployeesBean.selectedDays.size()>0}"
                                                   style="display: flex; align-items: end; gap: 15px; justify-content: space-between; flex-wrap: wrap;">
                                        <div class="time-group">
                                            <p:outputLabel value="Default Start:" styleClass="default-label" />
                                            <p:datePicker id="defaultStartTime"
                                                          value="#{manageEmployeesBean.defaultStartTime}"
                                                          timeOnly="true"
                                                          placeholder="HH:MM"
                                                          pattern="HH:mm"
                                                          hourFormat="12"
                                                          showTime="true"
                                                          showIcon="false"
                                                          stepMinute="1"
                                                          styleClass="small-time-picker" />
                                        </div>

                                        <div class="time-group">
                                            <p:outputLabel value="Default End:" styleClass="default-label" />
                                            <p:datePicker id="defaultEndTime"
                                                          value="#{manageEmployeesBean.defaultEndTime}"
                                                          timeOnly="true"
                                                          placeholder="HH:MM"
                                                          pattern="HH:mm"
                                                          hourFormat="12"
                                                          showTime="true"
                                                          showIcon="false"
                                                          stepMinute="1"
                                                          styleClass="small-time-picker" />
                                        </div>

                                        <p:commandButton value="Fill All Selected Days" 
                                                         icon="pi pi-copy" 
                                                         action="#{manageEmployeesBean.fillDefaultTimesToSelectedDays}" 
                                                         update="dayTimeInputs" 
                                                         process="@this defaultStartTime defaultEndTime"
                                                         styleClass="ui-button-success ui-button-sm"
                                                         disabled="#{empty manageEmployeesBean.selectedDays}" />
                                    </p:outputPanel>
                                </div>

                                <h3 class="section-title">
                                    <i class="pi pi-calendar" style="margin-right:8px;color:#22C55E;" />
                                    Assign CUSTOM Time Range For Days
                                </h3>
                                <ui:repeat value="#{manageEmployeesBean.selectedDays}" var="day">
                                    <div class="day-time-block">
                                        <!-- Day label -->
                                        <h:outputText value="#{day}" styleClass="day-title" />
                                        <div class="time-row">
                                            <div class="time-group">
                                                <i class="pi pi-clock" style="color:#6366F1;" />
                                                <p:outputLabel value="Start:" styleClass="label-style" />
                                                <p:datePicker id="startTime"
                                                              value="#{manageEmployeesBean.startTimes[day]}"
                                                              timeOnly="true"
                                                              placeholder="HH:MM"
                                                              pattern="HH:mm"
                                                              hourFormat="12"
                                                              showTime="true"
                                                              showIcon="false"
                                                              stepMinute="1"
                                                              styleClass="small-time-picker" />
                                            </div>
                                            <div class="time-group">
                                                <i class="pi pi-clock" style="color:#EF4444;" />
                                                <p:outputLabel value="End:" styleClass="label-style" />
                                                <p:datePicker id="endTime"
                                                              value="#{manageEmployeesBean.endTimes[day]}"
                                                              timeOnly="true"
                                                              placeholder="HH:MM"
                                                              pattern="HH:mm"
                                                              hourFormat="12"
                                                              showTime="true"
                                                              showIcon="false"
                                                              stepMinute="1"
                                                              styleClass="small-time-picker" />
                                            </div>
                                            <p:commandButton icon="pi pi-trash" 
                                                             styleClass="rounded-button ui-button-danger ui-button-outlined deletebutton"
                                                             title="Remove this day"
                                                             process="@this"
                                                             actionListener="#{manageEmployeesBean.deleteDayTimeTule(day)}"
                                                             update=":sidebarForm:timeSettings :employeeForm:growl" />
                                        </div>
                                    </div><p:separator />
                                    <p:spacer height="10px"/>
                                </ui:repeat>
                            </h:panelGroup>
                        </p:outputPanel>

                        <div class="dialog-footer">
                            <p:commandButton value="Save Rule" icon="pi pi-save" 
                                             action="#{manageEmployeesBean.saveDayTimeRules()}"
                                             update="employeeForm :sidebarForm" 
                                             styleClass="save" />
                        </div>
                    </h:form>
                </p:sidebar> 
            </div>

        </div>

        <script>

            //<![CDATA[
            // Wait for DOM to be fully loaded
            document.addEventListener('DOMContentLoaded', function () {
                // Safely attach event listeners only if elements exist
                var profileBtn = document.getElementById('profileBtn');
                var profileModal = document.getElementById('profileModal');
                var closeModal = document.getElementById('closeModal');

                if (profileBtn && profileModal) {
                    profileBtn.addEventListener('click', function () {
                        profileModal.style.display = 'flex';
                    });
                }

                if (closeModal && profileModal) {
                    closeModal.addEventListener('click', function () {
                        profileModal.style.display = 'none';
                    });
                }

                if (profileModal) {
                    profileModal.addEventListener('click', function (e) {
                        if (e.target === this) {
                            this.style.display = 'none';
                        }
                    });
                }
            });
            //]]>
        </script>
    </ui:define>
</ui:composition>
