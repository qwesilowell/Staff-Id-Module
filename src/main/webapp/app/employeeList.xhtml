<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>

<ui:composition template="/WEB-INF/templates.xhtml"
                xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="jakarta.faces.html"
                xmlns:f="jakarta.faces.core"
                xmlns:p="http://primefaces.org/ui"
                xmlns:ui="jakarta.faces.facelets">

    <ui:define name ="title">Employee List</ui:define>
    <ui:define name="head">
        <h:outputStylesheet library="css" name="manageEmployee.css"/>
    </ui:define>
    <ui:define name ="content">
        <!-- Main Content -->
        <div class="main-content" >
            <h3>EMPLOYEE PROFILES</h3>
            <h:form id="employeeForm">
                <h:panelGroup layout="block" style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                    <p:growl widgetVar="fgrowl" id="growl" showSummary= "false" showDetail="true" life="6000" globalOnly="true"/>
                    <!-- Search Bar on the Left --> 
                    <p:inputText id="search" value="#{manageEmployeesBean.searchQuery}"
                                 placeholder="Search by Name or Ghana Card"
                                 styleClass="search-box"
                                 style="flex: 1; max-width: 300px;">
                        <p:ajax event="keyup" listener="#{manageEmployeesBean.findEmployee}" update="employeeTable"/>
                    </p:inputText>

                    <!-- Add New Employee Button on the Right -->
                    <p:commandButton value="Add New Employee" icon="pi pi-plus" action="#{manageEmployeesBean.goToSignup}" 
                                     ajax="false" style="font-size: 1em; background-color: #FFF8E1; color: black; margin-left: auto;" />
                </h:panelGroup>

                <p:spacer height="30px"/>


                <!-- Employee List -->
                <p:dataTable id="employeeTable" value="#{manageEmployeesBean.employees}" var="employee" 
                             paginator="true" paginatorPosition="bottom" rows="10"  rowIndexVar="rowIndex"  rowStyleClass="#{rowIndex mod 2 eq 0 ? 'white-row' : 'ash-row'}">

                    <p:column headerText="First Name">
                        <h:outputText value="#{employee.firstname}" />
                    </p:column>

                    <p:column headerText="Last Name">
                        <h:outputText value="#{employee.lastname}" />
                    </p:column>

                    <p:column headerText="Ghana Card Number">
                        <h:outputText value="#{employee.ghanaCardNumber}" />
                    </p:column>

                    <p:column headerText="Email">
                        <h:outputText value="#{employee.email}" />
                    </p:column>

                    <p:column headerText="Actions">
                        <p:commandButton value="View" icon="pi pi-eye" id="profileBtn"
                                         action="#{manageEmployeesBean.viewEmployee(employee.ghanaCardNumber)}" 
                                         update=":employeeForm:profileModal :sidebarForm"
                                         oncomplete="PF('profileDialog').show();" />
                    </p:column>
                </p:dataTable>
                <!-- Profile Modal -->
                <p:dialog id="profileModal" 
                          widgetVar="profileDialog"
                          responsive="true"
                          modal="true" 
                          blockScroll= "true" >

                    <div class="modal-overlay">
                        <div class="profile-modal">
                            <div class="modal-header">
                                <h2 class="modal-title">Profile</h2>
                                <button class="close-button" id="closeModal">Ã—</button>
                            </div>

                            <div class="profile-content">
                                <div class="user-profile">
                                    <div class="profile-avatar"><strong>#{manageEmployeesBean.selectedEmployeeInitials}</strong></div>
                                    <h1 class="user-name">#{manageEmployeesBean.selectedEmployee.fullName}</h1>
                                    <div class="user-email">#{manageEmployeesBean.selectedEmployee.email}</div>
                                    <h3 class = "gh-no">#{manageEmployeesBean.selectedEmployee.ghanaCardNumber}</h3>
                                    <p class="user-bio">
                                        #{manageEmployeesBean.selectedEmployee.role} <span class="user-empstat">(#{manageEmployeesBean.selectedEmployee.employmentStatus})</span>
                                    </p>
                                </div>

                                <div class="divider"></div>


                                <div class="profile-section">
                                    <div style="display: flex; align-items: center; gap: 8px">
                                        <i class="fa-solid fa-door-open" ></i>
                                        <h3 class="section-title" style="margin: 0;">Entrance Details</h3>
                                    </div>
                                    <div class="profile-actions">
                                        <h:commandButton value=" Default Entrances"
                                                         action="#{manageEmployeesBean.toggleEntrances}"
                                                         styleClass="action-button">
                                            <f:ajax render="entrancesPanel" />
                                        </h:commandButton>

                                    </div>

                                    <h:panelGroup id="entrancesPanel">
                                        <h:panelGroup rendered="#{manageEmployeesBean.showEntrances}"
                                                      styleClass="skill-tags"
                                                      style="margin-top: 10px;">
                                            <ui:repeat value="#{manageEmployeesBean.selectedEmployeeEntrances}" var="entrance">
                                                <span class="skill-tag">#{entrance.entrance_Name}</span>
                                            </ui:repeat>
                                            <h:outputText value="No entrances assigned" rendered="#{empty manageEmployeesBean.selectedEmployeeEntrances}" />
                                        </h:panelGroup>
                                    </h:panelGroup>
                                    <p:spacer height="10px"/>


                                    <div class="profile-actions">
                                        <h:commandButton value=" Custom Entrances"
                                                         action="#{manageEmployeesBean.toggleCustomEntrances}"
                                                         styleClass="action-button">
                                            <f:ajax render="CustomEntrancesPanel" />
                                        </h:commandButton>

                                    </div>

                                    <h:panelGroup id="CustomEntrancesPanel">
                                        <h:panelGroup rendered="#{manageEmployeesBean.showCustomEntrances}"
                                                      styleClass="skill-tags"
                                                      style="margin-top: 10px;">
                                            <ui:repeat value="#{manageEmployeesBean.selectedCustomEmpEntrances}" var="entrance">
                                                <span class="skill-tag">#{entrance.entrance_Name}</span>
                                            </ui:repeat>
                                            <br/>
                                            <h:outputText value="No Custom entrances assigned" rendered="#{empty manageEmployeesBean.selectedCustomEmpEntrances}" />
                                        </h:panelGroup>
                                    </h:panelGroup>
                                </div>
                                <div class="divider"></div>

                                <!-- Time Access Info  and Customization-->
                                <div class="profile-section">
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <i class="fa-regular fa-clock"></i>
                                        <h3 class="section-title" style="margin: 0;">Custom Time Access Details</h3>
                                    </div>
                                    <h:panelGroup id="customTimeAccessPanel">
                                        <h:panelGroup  rendered="#{not empty manageEmployeesBean.getEmployeeTimeRules(manageEmployeesBean.selectedEmployee.ghanaCardNumber)}"
                                                       styleClass="skill-tags"
                                                       style="margin-top: 10px;">
                                            <ui:repeat value="#{manageEmployeesBean.getEmployeeTimeRules(manageEmployeesBean.selectedEmployee.ghanaCardNumber)}" var="rule">
                                                <span class="skill-tag">#{manageEmployeesBean.formatTimeRule(rule)}</span>                                            
                                            </ui:repeat>
                                        </h:panelGroup>
                                        <br/>
                                        <h:outputText value="No custom time rules assigned"
                                                      rendered="#{empty manageEmployeesBean.getEmployeeTimeRules(manageEmployeesBean.selectedEmployee.ghanaCardNumber)}"
                                                      style="font-style: italic; color: gray; font-weight: bold;" />
                                    </h:panelGroup>

                                    <div class="profile-actions">
                                        <p:commandButton value="Create Customized Time Access"
                                                         icon=" pi pi-cog"
                                                         update=":sidebarForm"
                                                         oncomplete="PF('sidebar2').show();PF('profileDialog').hide();"
                                                         styleClass="icon-expand-btn mr-2" />
                                    </div>
                                </div>
                            </div>

                            <div class="delete">
                                <p:commandButton value="Want to delete this employee account? Click here" 
                                                 styleClass="del-statement" 
                                                 process="@this" 
                                                 oncomplete="PF('deleteEmployeeDialog').show()" 
                                                 />
                            </div>
                            <button class="primary-button" onclick="PF('profileDialog').hide();">Close</button>
                        </div>
                    </div>
                </p:dialog>

                <p:dialog id="deleteEmployeeDialog" 
                          widgetVar="deleteEmployeeDialog" 
                          header="Confirm Deletion" 
                          modal="true" 
                          showEffect="fade" 
                          hideEffect="fade" 
                          resizable="false" 
                          width="300"
                          style="color:#9ca3af">
                    <h:panelGroup>
                        <h:outputText value="Are you sure you want to delete employee?" />

                        <!--                        <h:outputText value="#-{manageEmployeesBean.selectedEmployee.fullName} ?" style="display:block; margin-top:20px;" />-->
                    </h:panelGroup>              
                    <br/>
                    <br/>
                    <br/>
                    <div style="display:flex; flex-direction: row; justify-content: flex-end; gap: 10px;">
                        <p:commandButton value="Yes" 
                                         icon="pi pi-check" 
                                         action="#{manageEmployeesBean.deleteEmployee}" 
                                         update=":employeeForm:employeeTable :employeeForm:growl" 
                                         oncomplete="PF('deleteEmployeeDialog').hide(); PF('profileDialog').hide();" 
                                         styleClass="" />

                        <p:commandButton value="No" 
                                         type="button" 
                                         icon="pi pi-times" 
                                         onclick="PF('deleteEmployeeDialog').hide();" 
                                         styleClass="ui-button-secondary" />
                    </div>
                </p:dialog>
            </h:form>
            <!-- Side Bar -->
            <div class="card" >  
                <p:sidebar widgetVar="sidebar2" position="right" style="width: 30%; background-color: #f8f9fa; overflow:scroll "  blockScroll= "true">
                    <h:form id ="sidebarForm">
                        <h3>Customize Time Access</h3>
                        <div class="same-line-container">
                            <i class="pi pi-user p-mr-2 text-primary icon-style"></i>
                            <p:outputLabel value="Name: " styleClass="label-style" />
                            <h:outputText value="#{manageEmployeesBean.selectedEmployee.fullName}" styleClass="value-style" />
                        </div>
                        <br/>
                        <div class="same-line-container" >
                            <i class="fa-solid fa-address-card p-mr-2 text-primary icon-style"></i>
                            <p:outputLabel value="Ghana Card: " styleClass="label-style" />
                            <h:outputText value="#{manageEmployeesBean.selectedEmployee.ghanaCardNumber}" styleClass="value-style" />
                        </div>
                        <p:spacer height="20px"/>
                        <div class="same-line-container">
                            <i class="pi pi-building p-mr-2 text-success icon-style"></i>
                            <p:outputLabel value="Entrance:" styleClass="label-style" />
                            <h:panelGroup>
                                <!-- Select Entrance -->
                                <p:autoComplete id="entrance" value="#{manageEmployeesBean.selectedEntranceId}"
                                                completeMethod="#{manageEmployeesBean.searchAllEntrances}" 
                                                var="entrance" itemLabel="#{entrance.entrance_Name}" 
                                                itemValue="#{entrance.entrance_Device_ID}"
                                                forceSelection="true" dropdown="true"
                                                scrollHeight="200"
                                                placeholder="Search or Select Entrance" 
                                                style="width: 100%;  overflow: hidden">
                                    <p:ajax event="itemSelect" listener="#{manageEmployeesBean.prepareCustomTimeRules}" update="timeSettings" />     
                                </p:autoComplete>
                            </h:panelGroup>
                        </div>

                        <p:separator/>
                        <p:spacer height="30px"/>
                        <h:outputLabel value="Select Days" styleClass="day-title"/>
                        <p:outputPanel id="timeSettings">
                            <p:selectManyCheckbox value="#{manageEmployeesBean.selectedDays}" layout="grid" columns="3" id="daysCheckbox">
                                <f:selectItem itemLabel="Monday" itemValue="MONDAY" />
                                <f:selectItem itemLabel="Tuesday" itemValue="TUESDAY" />
                                <f:selectItem itemLabel="Wednesday" itemValue="Wednesday" />
                                <f:selectItem itemLabel="Thursday" itemValue="THURSDAY" />
                                <f:selectItem itemLabel="Friday" itemValue="FRIDAY" />
                                <f:selectItem itemLabel="Saturday" itemValue="SATURDAY" />
                                <f:selectItem itemLabel="Sunday" itemValue="SUNDAY" />
                                <p:ajax event="valueChange"
                                        listener="#{manageEmployeesBean.loadDayTimeInputs}"
                                        update="dayTimeInputs"
                                        process="@this" />
                            </p:selectManyCheckbox>


                            <p:spacer height="10px"/>

                            <h:panelGroup id="dayTimeInputs" layout="block">
                                <h3 class="section-title">
                                    <i class="pi pi-calendar" style="margin-right:8px;color:#22C55E;" />
                                    Assign CUSTOM Time Range For Days
                                </h3>
                                <ui:repeat value="#{manageEmployeesBean.selectedDays}" var="day">
                                    <div class="day-time-block">
                                        <!-- Day label -->
                                        <h:outputText value="#{day}" styleClass="day-title" />
                                        <div class="time-row">
                                            <div class="time-group">
                                                <i class="pi pi-clock" style="color:#6366F1;" />
                                                <p:outputLabel value="Start:" styleClass="label-style" />
                                                <p:datePicker id="startTime"
                                                              value="#{manageEmployeesBean.startTimes[day]}"
                                                              timeOnly="true"
                                                              placeholder="HH:MM"
                                                              pattern="HH:mm"
                                                              hourFormat="12"
                                                              showTime="true"
                                                              showIcon="false"
                                                              stepMinute="1"
                                                              styleClass="small-time-picker" />
                                            </div>
                                            <div class="time-group">
                                                <i class="pi pi-clock" style="color:#EF4444;" />
                                                <p:outputLabel value="End:" styleClass="label-style" />
                                                <p:datePicker id="endTime"
                                                              value="#{manageEmployeesBean.endTimes[day]}"
                                                              timeOnly="true"
                                                              placeholder="HH:MM"
                                                              pattern="HH:mm"
                                                              hourFormat="12"
                                                              showTime="true"
                                                              showIcon="false"
                                                              stepMinute="1"
                                                              styleClass="small-time-picker" />
                                            </div>
                                        </div>
                                    </div><p:separator />
                                    <p:spacer height="10px"/>
                                </ui:repeat>
                            </h:panelGroup>
                        </p:outputPanel>

                        <div class="dialog-footer">
                            <p:commandButton value="Save Rule" icon="pi pi-save" 
                                             action="#{manageEmployeesBean.saveDayTimeRules()}"
                                             update="employeeForm messages" 
                                             oncomplete="PF('sidebar2').hide()" 
                                             styleClass="save" />
                        </div>
                    </h:form>
                </p:sidebar> 
            </div>

        </div>

        <script>

            //<![CDATA[
            // Wait for DOM to be fully loaded
            document.addEventListener('DOMContentLoaded', function () {
                // Safely attach event listeners only if elements exist
                var profileBtn = document.getElementById('profileBtn');
                var profileModal = document.getElementById('profileModal');
                var closeModal = document.getElementById('closeModal');

                if (profileBtn && profileModal) {
                    profileBtn.addEventListener('click', function () {
                        profileModal.style.display = 'flex';
                    });
                }

                if (closeModal && profileModal) {
                    closeModal.addEventListener('click', function () {
                        profileModal.style.display = 'none';
                    });
                }

                if (profileModal) {
                    profileModal.addEventListener('click', function (e) {
                        if (e.target === this) {
                            this.style.display = 'none';
                        }
                    });
                }
            });
            //]]>
        </script>

        <style>
            .labelColumn {
                font-weight: 600;
                vertical-align: middle;
                padding-right: 15px;
                width: 35%;
                color: #374151;
            }
            .same-line-container {
                display: flex;
                align-items: center; /* Vertically align items in the container */
                gap: 10px; /* Adjust the spacing between the elements as needed */
            }

            .icon-style {
                font-size: 1.2rem; /* Apply the font size to all icons */
                margin-right: 0.5rem; /* Add a little space to the right of each icon */
                color:#644d12;
                ;
            }

            .label-style {
                font-weight: 600; /* Make the labels bold */
                color: #374151; /* Apply the label color */
            }

            .value-style {
                color: #111827; /* Apply the value color */
            }

            .days-container {
                background: #F9FAFB;
                border-radius: 8px;
                padding: 15px 10px 10px;
            }

            .days-checkboxes {
                width: 100%;
            }

            .days-checkboxes .ui-selectmanycheckbox label {
                margin-right: 8px;
                padding: 6px 0;
                font-weight: 500;
            }

            .days-checkboxes .ui-chkbox-box {
                border-radius: 4px;
            }

            /* Footer */
            .dialog-footer {
                background: #fafaf8;
                padding: 16px;
                display: flex;
                justify-content: flex-end;
                border-top: 1px solid #E5E7EB;
            }

            .p-dialog .ui-panelgrid td {
                padding: 10px 4px;
            }

            .custom-panelgrid {
                width: 100%;
            }

            .save {
                background-color: #2196f3;
                color: white !important;
                padding: 6px 4px !important;
            }

            .icon-expand-btn {
                overflow: hidden;
                white-space: nowrap;
                width: 40px; /* Show only the icon initially */
                transition: all 0.3s ease;
                padding-left: 5px;
                padding-right: 12px;
                color: #374151 !important;
                background-color: white !important ;
                border: none !important;
            }

            .icon-expand-btn .ui-button-text {
                opacity: 0;
                width: 0;
                display: inline-block;
                transition: opacity 0.3s ease, width 0.3s ease;
            }


            /* On hover, expand the button */
            .icon-expand-btn:hover {
                width: 290px; /* Adjust width as needed for text */
                background-color:#E5E7EB !important;
            }

            /* Fade in the text */
            .icon-expand-btn:hover .ui-button-text {
                opacity: 1;
                width: auto;
                margin-left: 5px;
            }
            .white-row {
                background-color: white !important;
            }

            .ash-row {
                background-color: #f0f0f0 !important;
            }
            .white-row:hover, .ash-row:hover {
                background-color: #dceeff !important;
                cursor: pointer;
            }


            .day-row {
                margin-bottom: 20px; /* Space between days */
            }
            .day-title {
                font-weight: bold;
                font-size: 1.2em;
                margin-bottom: 8px;
                color: #333;
            }

            .time-row {
                display: flex;
                align-items: center;
                gap: 20px;
                flex-wrap: wrap;
                margin-top: 6px;
            }

            /* Align label, icon, and input within each group */
            .time-group {
                display: flex;
                align-items: center;
                gap: 6px;
            }

            /* Make the time input smaller and tighter */
            .small-time-picker .ui-inputfield {
                width: 100% !important;
                font-size: 0.75rem !important;
                padding: 4px 6px !important;
            }

            /* Optional: reduce margin around output labels */
            .label-style {
                font-size: 0.75rem;
                margin: 0;
                font-style: italic;
            }
            @media (max-width: 600px) {
                .time-row {
                    flex-direction: column; /* Stack vertically on small screens */
                    align-items: flex-start;
                }
                .time-group .p-datepicker {
                    width: 100%; /* Full width on mobile */
                }
            }
        </style>

    </ui:define>
</ui:composition>
